<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech App with Mr. Oz</title>

  <style>
    :root{
      --bg:#f5f5f7;
      --card: rgba(255,255,255,0.90);
      --text:#1d1d1f;
      --muted: rgba(29,29,31,0.62);
      --line: rgba(0,0,0,0.10);

      --blue:#0071e3;
      --teal:#00a3a3;
      --indigo:#5e5ce6;
      --pink:#ff2d55;

      --shadow: 0 10px 28px rgba(0,0,0,0.10);
      --shadow2: 0 18px 54px rgba(0,0,0,0.14);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family:
        -apple-system, BlinkMacSystemFont,
        "SF Pro Display","SF Pro Text",
        "Helvetica Neue", Helvetica, Arial,
        "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 50% 0%, #ffffff 0%, var(--bg) 55%, #efeff2 100%);
      color: var(--text);
      display:flex;
      flex-direction:column;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      letter-spacing: -0.01em;
    }

    header{
      background: rgba(255,255,255,0.78);
      border-bottom: 1px solid var(--line);
      padding: 12px 16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .hdr{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      max-width: 1400px;
      margin: 0 auto;
      gap: 12px;
    }

    h1{
      margin:0;
      text-align:center;
      font-size: clamp(30px, 2.8vw, 54px);
      font-weight: 900;
      letter-spacing: -0.02em;
      white-space: nowrap;
    }

    .chipWrap{
      display:inline-flex;
      flex-direction:column;
      gap:6px;
    }

    .chipLabel{
      font-size: clamp(12px, 1.0vw, 16px);
      font-weight: 800;
      letter-spacing: -0.01em;
      color: rgba(29,29,31,0.60);
      padding-left: 4px;
    }

    .chip{
      display:inline-block;
      padding: 10px 14px;
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 14px;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      font-size: clamp(22px, 2vw, 40px);
      white-space: nowrap;
      color: rgba(29,29,31,0.92);
      background: rgba(255,255,255,0.90);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      position: relative;
      overflow: hidden;
    }
    .chip::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 16px;
      background: conic-gradient(
        from 210deg,
        rgba(0,0,0,0) 0deg,
        rgba(0,0,0,0) 65deg,
        rgba(0,113,227,0.85) 120deg,
        rgba(0,163,163,0.75) 170deg,
        rgba(94,92,230,0.70) 230deg,
        rgba(255,45,85,0.70) 285deg,
        rgba(0,0,0,0) 340deg,
        rgba(0,0,0,0) 360deg
      );
      filter: blur(16px);
      opacity: 0.22;
      pointer-events:none;
    }

    main{
      flex:1;
      display:flex;
      justify-content:center;
      padding: 14px 16px;
    }
    .grid{
      width: min(1400px, 100%);
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      align-items: stretch;
    }

    .card{
      position: relative;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      opacity: 0.50;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transform: translateY(0);
      transition: opacity .18s ease, transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 20px;
      background: conic-gradient(
        from 180deg,
        rgba(0,0,0,0) 0deg,
        rgba(0,0,0,0) 40deg,
        rgba(255,45,85,0.70) 95deg,
        rgba(94,92,230,0.70) 155deg,
        rgba(0,163,163,0.60) 215deg,
        rgba(0,113,227,0.78) 275deg,
        rgba(0,0,0,0) 330deg,
        rgba(0,0,0,0) 360deg
      );
      filter: blur(16px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease;
    }

    .card.active{
      opacity: 1;
      transform: translateY(-6px);
      border-color: rgba(0,0,0,0.14);
      box-shadow: var(--shadow2);
    }
    .card.active::before{
      opacity: 0.72;
      animation: spin 4.6s linear infinite; /* biraz daha sakin */
    }
    @keyframes spin{
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    .title{
      text-align:center;
      font-weight: 900;
      font-size: clamp(18px, 1.6vw, 30px);
      letter-spacing: -0.01em;
      position: relative;
      z-index: 2;
    }
    .mins{
      display:block;
      margin-top: 4px;
      font-weight: 800;
      color: var(--muted);
      font-size: 0.82em;
    }

    .circleWrap{
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      display:grid;
      place-items:center;
      z-index: 2;
    }

    .ringSvg{
      position:absolute;
      inset:-6px;                 /* halka daha disari */
      width: calc(100% + 12px);
      height: calc(100% + 12px);
      transform: rotate(-90deg);
      pointer-events:none;
    }
    .ringTrack{
      fill:none;
      stroke: rgba(0,0,0,0.10);
      stroke-width: 12;
    }
    .ringProg{
      fill:none;
      stroke-width: 12;
      stroke-linecap: round;
      stroke: var(--blue);
      opacity: 0.95;
      stroke-dasharray: 1 9999;
      stroke-dashoffset: 0;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,0.18));
      transition: opacity .15s ease;
    }
    .card .ringProg{ opacity: 0; }
    .card.active .ringProg{ opacity: 1; }

    /* RESIMLER DAHA BUYUK GORUNSUN */
    .imgwrap{
      width: calc(100% - 8px);     /* eskiden -22 idi, resim kuculuyordu */
      height: calc(100% - 8px);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.92);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
      position: relative;
    }
    .imgwrap img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.06);      /* biraz zoom: daha dolu dursun */
    }

    /* coin flip: 3D flip bazen “sikitili” hissediyor.
       Bunu daha soft crossfade + yavas rotate gibi yaptim. */
    .coin{
      width:100%;
      height:100%;
      position:relative;
    }
    .coinFace{
      position:absolute;
      inset:0;
      opacity:0;
      animation: faceFade 6s linear infinite;
    }
    .coinFace img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.06);
    }
    .coinFront{ animation-delay: 0s; }
    .coinBack { animation-delay: 3s; }

    @keyframes faceFade{
      0%   { opacity:0; transform: rotate(0deg); }
      10%  { opacity:1; transform: rotate(0deg); }
      40%  { opacity:1; transform: rotate(6deg); }
      50%  { opacity:0; transform: rotate(10deg); }
      100% { opacity:0; transform: rotate(10deg); }
    }

    .cdLabel{
      text-align:center;
      font-size: clamp(12px, 1.1vw, 16px);
      font-weight: 800;
      color: rgba(29,29,31,0.58);
      margin-top: 2px;
      visibility:hidden;
      position: relative;
      z-index: 2;
    }
    .card.active .cdLabel{ visibility:visible; }

    .cd{
      text-align:center;
      font-weight: 950;
      font-variant-numeric: tabular-nums;
      font-size: clamp(30px, 3.1vw, 64px); /* countdown biraz buyudu */
      color: var(--text);
      visibility:hidden;
      position: relative;
      z-index: 2;
    }
    .card.active .cd{ visibility:visible; }

    footer{
      background: rgba(255,255,255,0.78);
      border-top: 1px solid var(--line);
      padding: 10px 16px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .footerRow{
      max-width: 1400px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .infoBox{
      display:flex;
      flex-direction:column;
      gap: 4px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--line);
      box-shadow: 0 10px 22px rgba(0,0,0,0.08);
      min-width: 360px;
      flex: 1;
    }

    .infoTop{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: baseline;
    }

    .pill{
      font-weight: 900;
      letter-spacing: -0.01em;
      color: rgba(29,29,31,0.92);
      font-size: clamp(14px, 1.3vw, 18px);
    }

    .subpill{
      font-weight: 800;
      color: rgba(29,29,31,0.62);
      font-size: clamp(13px, 1.2vw, 16px);
    }

    .mini{
      margin-top: 2px;
      font-weight: 800;
      color: rgba(29,29,31,0.62);
      font-size: clamp(12px, 1.1vw, 15px);
    }

    .switchBox{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--line);
      box-shadow: 0 10px 22px rgba(0,0,0,0.08);
      white-space: nowrap;
    }

    .swText{
      font-weight: 900;
      color: rgba(29,29,31,0.90);
      font-size: clamp(14px, 1.3vw, 18px);
    }

    .switch{
      position: relative;
      width: 56px;
      height: 32px;
    }
    .switch input{
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider{
      position:absolute;
      inset:0;
      cursor:pointer;
      background: rgba(0,0,0,0.18);
      border-radius: 999px;
      transition: background .18s ease;
      border: 1px solid rgba(0,0,0,0.12);
    }
    .slider:before{
      content:"";
      position:absolute;
      height: 26px;
      width: 26px;
      left: 3px;
      top: 50%;
      transform: translateY(-50%);
      background: #fff;
      border-radius: 999px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.18);
      transition: transform .18s ease;
    }
    .switch input:checked + .slider{
      background: rgba(0,113,227,0.80);
      border-color: rgba(0,113,227,0.45);
    }
    .switch input:checked + .slider:before{
      transform: translate(24px, -50%);
    }

    /* Footer button (doorbell) */
    .btn{
      appearance:none;
      border: 1px solid rgba(0,0,0,0.14);
      background: rgba(255,255,255,0.92);
      color: rgba(29,29,31,0.92);
      font-weight: 900;
      font-size: clamp(14px, 1.2vw, 18px);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.08);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, box-shadow .12s ease;
      white-space: nowrap;
    }
    .btn:active{
      transform: translateY(1px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.10);
    }
    .btnRow{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
      h1{ white-space: normal; }
      .infoBox{ min-width: 260px; }
    }
    @media (max-width: 560px){
      .hdr{ grid-template-columns: 1fr; justify-items:center; }
      .grid{ grid-template-columns: 1fr; }
    }

    @media (prefers-reduced-motion: reduce){
      .card, .card::before, .coinFace { transition:none; animation:none; }
    }
  </style>
</head>

<body>
  <header>
    <div class="hdr">
      <div class="chipWrap">
        <div class="chipLabel">Date</div>
        <span class="chip" id="dateChip">01/08/2026</span>
      </div>

      <h1>Tech App with Mr. Oz</h1>

      <div class="chipWrap" style="justify-self:end; text-align:right;">
        <div class="chipLabel">Time</div>
        <span class="chip" id="timeChip">11:12:22 AM</span>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <div class="card" data-stage="0">
        <div class="title">Login <span class="mins" id="label0">3 min</span></div>

        <div class="circleWrap">
          <svg class="ringSvg" viewBox="0 0 100 100" aria-hidden="true">
            <circle class="ringTrack" cx="50" cy="50" r="46"></circle>
            <circle class="ringProg"  cx="50" cy="50" r="46"></circle>
          </svg>
          <div class="imgwrap"><img src="./images/login.png" alt="Login"></div>
        </div>

        <div class="cdLabel">Remaining time</div>
        <div class="cd" id="cd0">--:--</div>
      </div>

      <div class="card" data-stage="1">
        <div class="title">Learning.com <span class="mins" id="label1">30 min</span></div>

        <div class="circleWrap">
          <svg class="ringSvg" viewBox="0 0 100 100" aria-hidden="true">
            <circle class="ringTrack" cx="50" cy="50" r="46"></circle>
            <circle class="ringProg"  cx="50" cy="50" r="46"></circle>
          </svg>
          <div class="imgwrap"><img src="./images/learning.png" alt="Learning.com"></div>
        </div>

        <div class="cdLabel">Remaining time</div>
        <div class="cd" id="cd1">--:--</div>
      </div>

      <div class="card" data-stage="2" id="typingCard">
        <div class="title" id="typingTitle">Typing / NitroType <span class="mins" id="label2">10 min</span></div>

        <div class="circleWrap">
          <svg class="ringSvg" viewBox="0 0 100 100" aria-hidden="true">
            <circle class="ringTrack" cx="50" cy="50" r="46"></circle>
            <circle class="ringProg"  cx="50" cy="50" r="46"></circle>
          </svg>

          <div class="imgwrap" aria-label="Typing stage (dynamic)">
            <div class="coin" id="typingCoin">
              <div class="coinFace coinFront"><img id="coinFrontImg" src="./typing.jpg" alt="Front" /></div>
              <div class="coinFace coinBack"><img id="coinBackImg" src="./nitrotype.jpg" alt="Back" /></div>
            </div>
          </div>
        </div>

        <div class="cdLabel">Remaining time</div>
        <div class="cd" id="cd2">--:--</div>
      </div>

      <div class="card" data-stage="3">
        <div class="title">Logout <span class="mins" id="label3">2 min</span></div>

        <div class="circleWrap">
          <svg class="ringSvg" viewBox="0 0 100 100" aria-hidden="true">
            <circle class="ringTrack" cx="50" cy="50" r="46"></circle>
            <circle class="ringProg"  cx="50" cy="50" r="46"></circle>
          </svg>
          <div class="imgwrap"><img src="./images/logout.png" alt="Logout"></div>
        </div>

        <div class="cdLabel">Remaining time</div>
        <div class="cd" id="cd3">--:--</div>
      </div>
    </div>
  </main>

  <footer>
    <div class="footerRow">
      <div class="infoBox">
        <div class="infoTop">
          <div class="pill" id="footerClass">Class: —</div>
          <div class="subpill" id="footerPeriod">Period: —</div>
        </div>
        <div class="mini" id="footerRange">Time: —</div>
        <div class="mini" id="footerExtra">—</div>
      </div>

      <div class="btnRow">
        <button class="btn" id="bellBtn" type="button">Ring Bell</button>

        <div class="switchBox">
          <div class="swText" id="simLabel">Simulation: OFF</div>
          <label class="switch" title="Simulation mode">
            <input type="checkbox" id="simSwitch" />
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- Put your sound file in the SAME folder as this HTML.
         Example names: doorbell.mp3 or bell.mp3 -->
    <audio id="stageSound" src="doorbell.mp3" preload="auto"></audio>
  </footer>

  <script>
    // ROUTINE DURATIONS
    const assignedMinutes = [3, 30, 10, 2]; // login=3, learning=30, typing=10, logout=2
    const SCALE_TO_PERIOD = true;

    // TIMEZONE
    const TZ = 'America/Chicago';

    // YOUR WEEKLY TEACHER SCHEDULE
    const teacherScheduleByDay = {
      1: [ // MON
        { title:'5A', start:'7:50am', end:'8:38am' },
        { title:'2B', start:'8:41am', end:'9:29am' },
        { title:'3A', start:'9:32am', end:'10:20am' },
        { title:'3A Recess', start:'10:20am', end:'10:23am' },
        { title:'1A', start:'12:04pm', end:'12:52pm' },
        { title:'2A', start:'12:55pm', end:'1:43pm' },
        { title:'PKB', start:'2:37pm', end:'3:25pm' },
        { title:'Dismissal Duty', start:'3:25pm', end:'3:40pm' },
        { title:'Robotic Club', start:'4:00pm', end:'5:00pm' },
      ],
      2: [ // TUE
        { title:'2B', start:'8:41am', end:'9:29am' },
        { title:'4A', start:'9:32am', end:'10:20am' },
        { title:'4A Recess', start:'10:23am', end:'10:26am' },
        { title:'3A', start:'11:13am', end:'12:01pm' },
        { title:'1B', start:'12:04pm', end:'12:52pm' },
        { title:'2A', start:'12:55pm', end:'1:43pm' },
        { title:'PKC', start:'1:46pm', end:'2:34pm' },
        { title:'1A', start:'2:37pm', end:'3:25pm' },
      ],
      3: [ // WED
        { title:'4B', start:'7:50am', end:'8:38am' },
        { title:'5A', start:'9:32am', end:'10:20am' },
        { title:'5A Recess', start:'10:20am', end:'10:23am' },
        { title:'KB', start:'11:13am', end:'12:01pm' },
        { title:'5B', start:'12:04pm', end:'12:52pm' },
        { title:'PKA', start:'1:46pm', end:'2:34pm' },
        { title:'KA', start:'2:37pm', end:'3:25pm' },
      ],
      4: [ // THU
        { title:'Morning Duty', start:'7:30am', end:'7:50am' },
        { title:'4A', start:'7:50am', end:'8:38am' },
        { title:'4B', start:'8:41am', end:'9:29am' },
        { title:'5B', start:'9:32am', end:'10:20am' },
        { title:'5B In Door Recess', start:'10:20am', end:'10:23am' },
        { title:'KA', start:'12:04pm', end:'12:52pm' },
        { title:'KB', start:'12:55pm', end:'1:43pm' },
        { title:'Dismissal Duty', start:'3:25pm', end:'3:40pm' },
      ],
      5: [ // FRI
        { title:'Morning Duty', start:'7:30am', end:'7:50am' },
        { title:'GT Elective Grs K-5', start:'9:24am', end:'10:08am' },
        { title:'1B', start:'12:31pm', end:'1:15pm' },
        { title:'Dismissal Duty', start:'3:25pm', end:'3:40pm' },
      ],
    };

    // BELL SCHEDULE
    const scheduleMonThu = [
      { name:'Breakfast', type:'nonclass', start:'07:20', end:'07:47' },
      { name:'Passing',   type:'nonclass', start:'07:47', end:'07:50' },
      { name:'Period 1',  type:'class',    start:'07:50', end:'08:38' },
      { name:'Passing',   type:'nonclass', start:'08:38', end:'08:41' },
      { name:'Period 2',  type:'class',    start:'08:41', end:'09:29' },
      { name:'Passing',   type:'nonclass', start:'09:29', end:'09:32' },
      { name:'Period 3',  type:'class',    start:'09:32', end:'10:20' },
      { name:'Passing',   type:'nonclass', start:'10:20', end:'10:23' },
      { name:'Period 4',  type:'class',    start:'10:23', end:'11:10' },
      { name:'Passing',   type:'nonclass', start:'11:10', end:'11:13' },
      { name:'Period 5',  type:'class',    start:'11:13', end:'12:01' },
      { name:'Passing',   type:'nonclass', start:'12:01', end:'12:04' },
      { name:'Period 6',  type:'class',    start:'12:04', end:'12:52' },
      { name:'Passing',   type:'nonclass', start:'12:52', end:'12:55' },
      { name:'Period 7',  type:'class',    start:'12:55', end:'13:43' },
      { name:'Passing',   type:'nonclass', start:'13:43', end:'13:46' },
      { name:'Period 8',  type:'class',    start:'13:46', end:'14:34' },
      { name:'Passing',   type:'nonclass', start:'14:34', end:'14:37' },
      { name:'Period 9',  type:'class',    start:'14:37', end:'15:25' },
    ];

    const scheduleFriday = [
      { name:'Breakfast', type:'nonclass', start:'07:20', end:'07:47' },
      { name:'Passing',   type:'nonclass', start:'07:47', end:'07:50' },
      { name:'Period 1',  type:'class',    start:'07:50', end:'08:34' },
      { name:'Passing',   type:'nonclass', start:'08:34', end:'08:37' },
      { name:'Period 2',  type:'class',    start:'08:37', end:'09:21' },
      { name:'Passing',   type:'nonclass', start:'09:21', end:'09:24' },
      { name:'Period 3',  type:'class',    start:'09:24', end:'10:08' },
      { name:'Passing',   type:'nonclass', start:'10:08', end:'10:11' },
      { name:'Period 4',  type:'class',    start:'10:11', end:'10:54' },
      { name:'Passing',   type:'nonclass', start:'10:54', end:'10:57' },
      { name:'Period 5',  type:'class',    start:'10:57', end:'11:41' },
      { name:'Passing',   type:'nonclass', start:'11:41', end:'11:44' },
      { name:'Period 6',  type:'class',    start:'11:44', end:'12:28' },
      { name:'Passing',   type:'nonclass', start:'12:28', end:'12:31' },
      { name:'Period 7',  type:'class',    start:'12:31', end:'13:15' },
    ];

    // Simulation
    let simulationOn = false;
    const SIM_SPEED = 60;
    let simAnchorRealMs = null;
    let simAnchorScheduleMin = null;

    // UI
    const dateChip = document.getElementById('dateChip');
    const timeChip = document.getElementById('timeChip');
    const cards = document.querySelectorAll('.card');
    const cds = [0,1,2,3].map(i => document.getElementById('cd'+i));
    const ringProgs = Array.from(document.querySelectorAll('.ringProg'));

    const footerClass = document.getElementById('footerClass');
    const footerPeriod = document.getElementById('footerPeriod');
    const footerRange = document.getElementById('footerRange');
    const footerExtra = document.getElementById('footerExtra');

    const simSwitch = document.getElementById('simSwitch');
    const simLabel = document.getElementById('simLabel');

    const stageSound = document.getElementById('stageSound');
    const bellBtn = document.getElementById('bellBtn');

    const typingTitle = document.getElementById('typingTitle');
    const coinFrontImg = document.getElementById('coinFrontImg');
    const coinBackImg  = document.getElementById('coinBackImg');

    // Bell button (manual)
    bellBtn.addEventListener('click', () => {
      playDoorbell();
    });

    // Helpers
    function hmToMin(hm){
      const [h,m] = hm.split(':').map(Number);
      return h*60 + m;
    }

    function nowInTZParts(tz){
      const parts = new Intl.DateTimeFormat('en-US',{
        timeZone: tz,
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit',
        hour12:false
      }).formatToParts(new Date());
      const get = (t) => parts.find(p => p.type === t)?.value;
      return {
        y:+get('year'), mo:+get('month'), d:+get('day'),
        h:+get('hour'), mi:+get('minute'), s:+get('second')
      };
    }

    function nowInTZDate(tz){
      const p = nowInTZParts(tz);
      return new Date(p.y, p.mo-1, p.d, p.h, p.mi, p.s);
    }

    function getNow(){
      const realNow = nowInTZDate(TZ);
      if(!simulationOn) return realNow;

      if(simAnchorRealMs === null){
        simAnchorRealMs = Date.now();
        simAnchorScheduleMin = realNow.getHours()*60 + realNow.getMinutes() + realNow.getSeconds()/60;
      }
      const elapsedRealSec = (Date.now() - simAnchorRealMs)/1000;
      const elapsedScheduleSec = elapsedRealSec * SIM_SPEED;
      const totalMin = simAnchorScheduleMin + elapsedScheduleSec/60;

      const base = new Date(realNow);
      base.setHours(0,0,0,0);

      const fake = new Date(realNow);
      fake.setTime(base.getTime() + totalMin*60*1000);
      return fake;
    }

    function getDaySchedule(d){
      const day = d.getDay();
      if(day === 5) return { type:'Friday', items:scheduleFriday };
      if(day >= 1 && day <= 4) return { type:'Mon-Thu', items:scheduleMonThu };
      return { type:'Weekend', items:[] };
    }

    function getSegmentForNow(items, nowMin){
      for(let i=0;i<items.length;i++){
        const it = items[i];
        const s = hmToMin(it.start);
        const e = hmToMin(it.end);
        if(nowMin >= s && nowMin < e){
          return { current: it, startMin:s, endMin:e };
        }
      }
      return { current:null, startMin:null, endMin:null };
    }

    function formatHMS(totalSeconds){
      totalSeconds = Math.max(0, Math.floor(totalSeconds));
      const h = Math.floor(totalSeconds/3600);
      const m = Math.floor((totalSeconds%3600)/60);
      const s = totalSeconds%60;
      if(h>0) return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
      return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    }

    function computeStageDurationsSec(periodLenSec){
      const totalMin = assignedMinutes.reduce((a,b)=>a+b,0);
      if(!SCALE_TO_PERIOD) return assignedMinutes.map(m => m*60);
      return assignedMinutes.map(m => (m/totalMin)*periodLenSec);
    }

    function stageAt(elapsedSec, durs){
      let acc=0;
      for(let i=0;i<durs.length;i++){
        const start=acc, end=acc+durs[i];
        if(elapsedSec >= start && elapsedSec < end) return { stage:i, stageStart:start, stageEnd:end };
        acc=end;
      }
      const total = durs.reduce((a,b)=>a+b,0);
      return { stage:3, stageStart: total-durs[3], stageEnd: total };
    }

    function playDoorbell(){
      stageSound.currentTime = 0;
      stageSound.play().catch(()=>{});
    }

    function updateHeader(now){
      const MM = String(now.getMonth()+1).padStart(2,'0');
      const DD = String(now.getDate()).padStart(2,'0');
      const YYYY = now.getFullYear();
      dateChip.textContent = `${MM}/${DD}/${YYYY}`;

      let h = now.getHours();
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12; if(h===0) h=12;

      const HH = String(h).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const ss = String(now.getSeconds()).padStart(2,'0');

      timeChip.textContent = `${HH}:${mm}:${ss} ${ampm}`;
    }

    function initRings(){
      ringProgs.forEach((c) => {
        const r = c.r.baseVal.value;
        const C = 2 * Math.PI * r;
        c.style.strokeDasharray = `${C} ${C}`;
        c.style.strokeDashoffset = `${C}`;
      });
    }

    function setRingProgress(stageIdx, pct){
      pct = Math.max(0, Math.min(100, pct));
      ringProgs.forEach((c, idx) => {
        const r = c.r.baseVal.value;
        const C = 2 * Math.PI * r;
        if(idx === stageIdx){
          const offset = C * (1 - pct/100);
          c.style.strokeDashoffset = `${offset}`;
        } else {
          c.style.strokeDashoffset = `${C}`;
        }
      });
    }

    // Parse "7:50am" -> minutes since midnight
    function time12ToMin(t){
      const m = String(t).trim().match(/^(\d{1,2}):(\d{2})(am|pm)$/i);
      if(!m) return null;
      let hh = parseInt(m[1],10);
      const mm = parseInt(m[2],10);
      const ap = m[3].toLowerCase();
      if(ap === 'pm' && hh !== 12) hh += 12;
      if(ap === 'am' && hh === 12) hh = 0;
      return hh*60 + mm;
    }

    function pickTeacherEvent(now){
      const day = now.getDay();
      const list = teacherScheduleByDay[day] || [];
      const nowMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;

      for(const ev of list){
        const s = time12ToMin(ev.start);
        const e = time12ToMin(ev.end);
        if(s === null || e === null) continue;
        if(nowMin >= s && nowMin < e){
          return { ...ev, startMin:s, endMin:e };
        }
      }
      return null;
    }

    function isPreK2(classTitle){
      if(!classTitle) return false;
      const t = classTitle.toUpperCase().trim();
      if(t.startsWith('PK')) return true;
      if(t === 'KA' || t === 'KB' || t === 'K') return true;
      const m = t.match(/^(\d)/);
      if(m){
        const d = parseInt(m[1],10);
        if(d === 1 || d === 2) return true;
      }
      return false;
    }

    function setTypingMode(prek2){
      if(prek2){
        typingTitle.innerHTML = 'PBS / ABC <span class="mins" id="label2">10 min</span>';
        coinFrontImg.src = './pbs.jpg';
        coinFrontImg.alt = 'PBS';
        coinBackImg.src  = './abc.jpg';
        coinBackImg.alt  = 'ABC';
      } else {
        typingTitle.innerHTML = 'Typing / NitroType <span class="mins" id="label2">10 min</span>';
        coinFrontImg.src = './typing.jpg';
        coinFrontImg.alt = 'Typing';
        coinBackImg.src  = './nitrotype.jpg';
        coinBackImg.alt  = 'NitroType';
      }
    }

    // Simulation switch
    simSwitch.addEventListener('change', () => {
      simulationOn = !!simSwitch.checked;
      simLabel.textContent = `Simulation: ${simulationOn ? 'ON' : 'OFF'}`;
      simAnchorRealMs = null;
      simAnchorScheduleMin = null;
      lastStage = -1;
      tick();
    });

    // Main tick
    let lastStage = -1;

    function tick(){
      const now = getNow();
      updateHeader(now);

      const dayInfo = getDaySchedule(now);

      const ev = pickTeacherEvent(now);
      const classText = ev ? ev.title : '—';
      const classIsPreK2 = ev ? isPreK2(ev.title) : false;
      setTypingMode(classIsPreK2);

      if(dayInfo.type === 'Weekend' || dayInfo.items.length === 0){
        cards.forEach(c => c.classList.remove('active'));
        cds.forEach(el => el.textContent='--:--');
        setRingProgress(-1, 0);

        footerClass.textContent = `Class: ${classText}`;
        footerPeriod.textContent = 'Period: Weekend';
        footerRange.textContent = 'Time: —';
        footerExtra.textContent = `Mode: ${simulationOn ? 'Sim' : 'Auto'}`;

        lastStage = -1;
        return;
      }

      const nowMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
      const seg = getSegmentForNow(dayInfo.items, nowMin);

      footerClass.textContent = `Class: ${classText}`;
      footerPeriod.textContent = `Period: ${seg.current ? seg.current.name : '—'}`;
      footerRange.textContent = `Time: ${seg.current ? (seg.current.start + '–' + seg.current.end) : '—'}`;

      let gradeLabel = '—';
      if(ev){
        gradeLabel = classIsPreK2 ? 'Group: PreK-2 (PBS/ABC)' : 'Group: 3-5 (Typing/NitroType)';
      }
      footerExtra.textContent = `${gradeLabel} | Mode: ${simulationOn ? 'Sim' : 'Auto'} | ${dayInfo.type}`;

      if(!seg.current || seg.current.type !== 'class'){
        cards.forEach(c => c.classList.remove('active'));
        cds.forEach(el => el.textContent='--:--');
        setRingProgress(-1, 0);
        lastStage = -1;
        return;
      }

      const segLenSec = (seg.endMin - seg.startMin)*60;
      const segElapsedSec = Math.max(0, Math.min(segLenSec, (nowMin - seg.startMin)*60));

      const durs = computeStageDurationsSec(segLenSec);
      const info = stageAt(segElapsedSec, durs);
      const stage = info.stage;

      cards.forEach((c, idx) => c.classList.toggle('active', idx === stage));

      cds.forEach((el, idx) => {
        if(idx === stage){
          const left = Math.max(0, info.stageEnd - segElapsedSec);
          el.textContent = formatHMS(left);

          const stageLen = Math.max(0.001, (info.stageEnd - info.stageStart));
          const stageElapsed = Math.max(0, Math.min(stageLen, segElapsedSec - info.stageStart));
          const pct = (stageElapsed / stageLen) * 100;
          setRingProgress(stage, pct);
        } else {
          el.textContent = '--:--';
        }
      });

      // Session change sound
      if(lastStage !== -1 && stage !== lastStage) playDoorbell();
      lastStage = stage;
    }

    initRings();
    simLabel.textContent = 'Simulation: OFF';
    setInterval(tick, 250);
    tick();
  </script>
</body>
</html>

