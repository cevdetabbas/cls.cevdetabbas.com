<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech App with Mr. Oz - Real Bell Schedule</title>

  <style>
    :root{
      --bg: #f5f5f7;
      --card: rgba(255,255,255,0.78);
      --text: #1d1d1f;
      --muted: rgba(29,29,31,0.68);
      --line: rgba(0,0,0,0.10);
      --shadow: 0 18px 45px rgba(0,0,0,0.10);
      --shadow2: 0 8px 20px rgba(0,0,0,0.08);

      --blue:  #0071e3;
      --green: #34c759;
      --amber: #ff9f0a;
      --pink:  #ff2d55;

      --gray: rgba(29,29,31,0.25);
    }

    html, body { height: 100%; }

    body {
      margin: 0;
      font-family:
        -apple-system, BlinkMacSystemFont,
        "SF Pro Display", "SF Pro Text",
        "Helvetica Neue", Helvetica, Arial,
        "Segoe UI", Roboto, "Noto Sans",
        "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 700px at 50% 0%, #ffffff 0%, var(--bg) 55%, #efeff2 100%);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      letter-spacing: -0.01em;
    }

    header {
      padding: 18px 0 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(245,245,247,0.70));
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .header-grid{
      max-width: 1320px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 520px;
      gap: 16px;
      align-items: start;
      padding: 0 14px;
    }

    .header-left{
      text-align: left;
      padding: 6px 0;
    }

    .header-left h1 {
      margin: 0;
      font-size: clamp(32px, 3.3vw, 44px);
      line-height: 1.06;
      letter-spacing: -0.02em;
      font-weight: 700;
      color: var(--text);
    }

    .header-left .subtitle {
      display: block;
      margin-top: 10px;
      font-size: 17px;
      line-height: 1.35;
      color: rgba(29,29,31,0.75);
      letter-spacing: -0.005em;
      font-weight: 500;
    }

    .subrow {
      margin-top: 10px;
      font-size: 14px;
      color: rgba(29,29,31,0.68);
      font-weight: 600;
      letter-spacing: -0.005em;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .pill {
      background: rgba(255,255,255,0.75);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space: nowrap;
    }

    /* MINI WEEKLY SCHEDULE (TOP RIGHT) */
    .mini-weekly{
      justify-self: end;
      width: 520px;
      background: rgba(255,255,255,0.72);
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 18px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.08);
      padding: 10px 10px 12px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .mw-title{
      font-size: 13px;
      font-weight: 800;
      color: rgba(29,29,31,0.70);
      letter-spacing: -0.01em;
      margin: 2px 6px 8px;
    }

    .mw-grid{
      display: grid;
      grid-template-columns: 40px repeat(5, 1fr);
      grid-auto-rows: 28px;
      gap: 6px;
      padding: 0 6px;
      position: relative;
    }

    .mw-corner{ background: transparent; }

    .mw-day{
      font-size: 12px;
      font-weight: 800;
      color: rgba(29,29,31,0.65);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .mw-rowlabel{
      font-size: 11px;
      font-weight: 800;
      color: rgba(29,29,31,0.55);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .mw-cell{
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.65);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 11px;
      font-weight: 700;
      color: rgba(29,29,31,0.70);
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .mw-cell.hasclass{
      background: linear-gradient(180deg, rgba(0,113,227,0.12), rgba(0,113,227,0.04));
      border-color: rgba(0,113,227,0.18);
    }

    .mw-cell.active{
      background: linear-gradient(180deg, rgba(255,45,85,0.18), rgba(255,45,85,0.06));
      border-color: rgba(255,45,85,0.35);
      box-shadow: 0 0 0 2px rgba(255,45,85,0.12) inset;
    }

    .mw-nowline{
      position: absolute;
      left: 0;
      right: 0;
      height: 0;
      pointer-events: none;
      z-index: 5;
      transform: translateY(0px);
      display: none;
    }

    .mw-nowline::before{
      content:'';
      position:absolute;
      left: 56px;
      right: 12px;
      top: 0;
      height: 2px;
      background: rgba(255,45,85,0.90);
      border-radius: 2px;
      box-shadow: 0 8px 18px rgba(255,45,85,0.22);
    }

    .mw-nowdot{
      position:absolute;
      left: 52px;
      top: -5px;
      width: 10px;
      height: 10px;
      background: rgba(255,45,85,0.95);
      border-radius: 999px;
      box-shadow: 0 10px 20px rgba(255,45,85,0.25);
    }

    .mw-nowlabel{
      position:absolute;
      top: -13px;
      left: 62px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(255,45,85,0.95);
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(255,45,85,0.25);
      border-radius: 999px;
      padding: 2px 8px;
      backdrop-filter: blur(10px);
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 34px 20px;
    }

    .card-row {
      display: flex;
      gap: 18px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 1200px;
      width: 100%;
    }

    .stage-card {
      background: var(--card);
      border-radius: 22px;
      padding: 22px;
      position: relative;
      box-shadow: var(--shadow2);
      border: 1px solid var(--line);
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, opacity 0.2s ease;
      min-width: 210px;
      flex: 1;
      max-width: 250px;
      overflow: hidden;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .stage-card.dimmed {
      opacity: 0.45;
      transform: none !important;
      box-shadow: 0 10px 18px rgba(0,0,0,0.06);
    }

    /* rainbow ring */
    .stage-card::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: conic-gradient(
        rgba(0,0,0,0) 0deg,
        rgba(0,0,0,0) 14deg,
        #ff2d55 70deg,
        #ff9f0a 110deg,
        #34c759 150deg,
        #0071e3 200deg,
        rgba(0,0,0,0) 260deg,
        rgba(0,0,0,0) 360deg
      );
      border-radius: 26px;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s ease;
      animation: none;
      filter: blur(10px);
      pointer-events: none;
    }

    .stage-card.active {
      transform: translateY(-10px) scale(1.03);
      border-color: transparent;
      box-shadow: var(--shadow);
    }

    .stage-card.active::before {
      opacity: 1;
      animation: neonRotate 3s linear infinite;
    }

    @keyframes neonRotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stage-title {
      font-size: 20px;
      line-height: 1.2;
      font-weight: 700;
      text-align: center;
      position: relative;
      z-index: 10;
      letter-spacing: -0.015em;
    }

    .stage-time {
      font-size: 14px;
      line-height: 1.25;
      text-align: center;
      position: relative;
      z-index: 10;
      color: rgba(29,29,31,0.62);
      font-weight: 600;
      letter-spacing: -0.005em;
    }

    .stage-image {
      flex: 1;
      border-radius: 14px;
      background-size: cover;
      background-position: center;
      min-height: 120px;
      position: relative;
      z-index: 10;
      border: 1px solid var(--line);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
    }

    .img-login   { background: linear-gradient(135deg, rgba(0,113,227,0.22) 0%, rgba(0,113,227,0.06) 100%); }
    .img-learn   { background: linear-gradient(135deg, rgba(52,199,89,0.22) 0%, rgba(52,199,89,0.06) 100%); }
    .img-typing  { background: linear-gradient(135deg, rgba(255,159,10,0.22) 0%, rgba(255,159,10,0.06) 100%); }
    .img-logout  { background: linear-gradient(135deg, rgba(255,45,85,0.22) 0%, rgba(255,45,85,0.06) 100%); }

    footer {
      padding: 18px 20px 24px;
      background: linear-gradient(180deg, rgba(245,245,247,0.78), rgba(255,255,255,0.78));
      border-top: 1px solid var(--line);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .timer-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      max-width: 1320px;
      margin-left: auto;
      margin-right: auto;
    }

    .time-label {
      font-size: 15px;
      line-height: 1.2;
      color: rgba(29,29,31,0.72);
      min-width: 360px;
      font-weight: 600;
      letter-spacing: -0.005em;
    }

    .time-label span {
      font-weight: 700;
      color: var(--blue);
    }

    .timer-bar {
      flex: 1;
      height: 24px;
      background: rgba(255,255,255,0.85);
      border-radius: 999px;
      border: 1px solid var(--line);
      overflow: hidden;
      position: relative;
      min-width: 350px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.9);
      max-width: 900px;
    }

    .smooth-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      border-radius: 999px;
      transition: width 0.12s linear;
      opacity: 0.95;
      pointer-events: none;
    }

    .progress-unit {
      position: absolute;
      top: 0;
      height: 100%;
      width: calc(100% / 45);
      opacity: 0.10;
      transition: opacity 0.2s ease;
      border-radius: 999px;
      pointer-events: none;
    }

    .progress-unit.stage-0 { background: linear-gradient(90deg, rgba(0,113,227,0.9), rgba(0,113,227,0.55)); }
    .progress-unit.stage-1 { background: linear-gradient(90deg, rgba(52,199,89,0.9), rgba(52,199,89,0.55)); }
    .progress-unit.stage-2 { background: linear-gradient(90deg, rgba(255,159,10,0.9), rgba(255,159,10,0.55)); }
    .progress-unit.stage-3 { background: linear-gradient(90deg, rgba(255,45,85,0.9), rgba(255,45,85,0.55)); }

    .progress-unit.active { opacity: 0.26; }

    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }

    .btn {
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      background: linear-gradient(180deg, rgba(0,113,227,0.95), rgba(0,113,227,0.80));
      color: #fff;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      box-shadow: 0 8px 18px rgba(0,113,227,0.18);
      letter-spacing: -0.01em;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 22px rgba(0,113,227,0.22);
    }

    .btn.secondary {
      background: linear-gradient(180deg, rgba(255,255,255,0.90), rgba(245,245,247,0.90));
      color: var(--text);
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }

    .btn.secondary:hover { box-shadow: 0 12px 22px rgba(0,0,0,0.10); }

    .status-text {
      text-align: center;
      font-size: 14px;
      color: rgba(29,29,31,0.68);
      margin-top: 8px;
      font-weight: 600;
      letter-spacing: -0.005em;
    }

    @media (prefers-reduced-motion: reduce) {
      .stage-card, .stage-card::before { transition: none; animation: none; }
      .smooth-fill { transition: none; }
    }

    @media (max-width: 1080px){
      .header-grid{ grid-template-columns: 1fr; }
      .mini-weekly{ width: min(520px, 100%); justify-self: center; }
      .header-left{ text-align: center; }
      .subrow{ justify-content: center; }
    }

    @media (max-width: 768px) {
      .card-row { flex-direction: column; gap: 15px; }
      .stage-card { max-width: none; flex: 1; min-width: 250px; }
      .timer-bar { min-width: 300px; }
      .time-label { min-width: 260px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-grid">
      <div class="header-left">
        <h1>Tech App with Mr. Oz</h1>
        <span class="subtitle">Real-time bell schedule + in-period routine</span>
        <div class="subrow">
          <div class="pill" id="todayTypePill">Today: ...</div>
          <div class="pill" id="nowPill">Now: ...</div>
          <div class="pill" id="nextPill">Next: ...</div>
        </div>
      </div>

      <div class="mini-weekly" id="miniWeekly">
        <div class="mw-title">Weekly Schedule</div>

        <div class="mw-grid" id="mwGrid">
          <div class="mw-corner"></div>
          <div class="mw-day">M</div>
          <div class="mw-day">T</div>
          <div class="mw-day">W</div>
          <div class="mw-day">R</div>
          <div class="mw-day">F</div>
          <!-- rows auto-filled by JS -->
        </div>

        <div class="mw-nowline" id="mwNowLine" aria-hidden="true">
          <div class="mw-nowdot"></div>
          <div class="mw-nowlabel" id="mwNowLabel">Now</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="card-row">
      <div class="stage-card" data-stage="0">
        <div class="stage-title">Login</div>
        <div class="stage-time" id="tLogin">...</div>
        <div class="stage-image img-login"></div>
      </div>
      <div class="stage-card" data-stage="1">
        <div class="stage-title">Learning.com</div>
        <div class="stage-time" id="tLearn">...</div>
        <div class="stage-image img-learn"></div>
      </div>
      <div class="stage-card" data-stage="2">
        <div class="stage-title">Typing.com</div>
        <div class="stage-time" id="tTyping">...</div>
        <div class="stage-image img-typing"></div>
      </div>
      <div class="stage-card" data-stage="3">
        <div class="stage-title">Logout</div>
        <div class="stage-time" id="tLogout">...</div>
        <div class="stage-image img-logout"></div>
      </div>
    </div>
  </main>

  <footer>
    <div class="timer-row">
      <div class="time-label">
        <span id="modeLabel">Auto</span> · <span id="timeLeftLabel">--:--</span> · <span id="segmentLabel">...</span>
      </div>
      <div class="timer-bar" id="timerBar"></div>
    </div>

    <div class="controls">
      <button class="btn secondary" id="toggleSimBtn">Simulation: OFF</button>
      <button class="btn" id="resetSimBtn">Reset Sim</button>
    </div>

    <div class="status-text" id="statusText">Uses local computer time. Simulation lets you test fast.</div>

    <audio id="stageSound" src="beep.mp3" preload="auto"></audio>
  </footer>

  <script>
    // Helper: "HH:MM" -> minutes since midnight
    function hmToMin(hm) {
      const parts = hm.split(':').map(Number);
      const h = parts[0] || 0;
      const m = parts[1] || 0;
      return h * 60 + m;
    }

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function formatHMS(totalSeconds) {
      totalSeconds = Math.max(0, Math.floor(totalSeconds));
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      if (h > 0) return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    function toMinSinceMidnight(dateObj) {
      return dateObj.getHours() * 60 + dateObj.getMinutes() + dateObj.getSeconds() / 60;
    }

    // =========================
    // 1) BELL SCHEDULE CONFIG
    // =========================
    const scheduleMonThu = [
      { name: 'Breakfast', type: 'nonclass', start: '07:20', end: '07:47' },
      { name: 'Passing',   type: 'nonclass', start: '07:47', end: '07:50' },

      { name: 'Period 1',  type: 'class',    start: '07:50', end: '08:38' },
      { name: 'Passing',   type: 'nonclass', start: '08:38', end: '08:41' },

      { name: 'Period 2',  type: 'class',    start: '08:41', end: '09:29' },
      { name: 'Passing',   type: 'nonclass', start: '09:29', end: '09:32' },

      { name: 'Period 3',  type: 'class',    start: '09:32', end: '10:20' },
      { name: 'Passing',   type: 'nonclass', start: '10:20', end: '10:23' },

      { name: 'Period 4',  type: 'class',    start: '10:23', end: '11:10' },
      { name: 'Passing',   type: 'nonclass', start: '11:10', end: '11:13' },

      { name: 'Period 5',  type: 'class',    start: '11:13', end: '12:01' },
      { name: 'Passing',   type: 'nonclass', start: '12:01', end: '12:04' },

      { name: 'Period 6',  type: 'class',    start: '12:04', end: '12:52' },
      { name: 'Passing',   type: 'nonclass', start: '12:52', end: '12:55' },

      { name: 'Period 7',  type: 'class',    start: '12:55', end: '13:43' },
      { name: 'Passing',   type: 'nonclass', start: '13:43', end: '13:46' },

      { name: 'Period 8',  type: 'class',    start: '13:46', end: '14:34' },
      { name: 'Passing',   type: 'nonclass', start: '14:34', end: '14:37' },

      { name: 'Period 9',  type: 'class',    start: '14:37', end: '15:25' }
    ];

    const scheduleFriday = [
      { name: 'Breakfast', type: 'nonclass', start: '07:20', end: '07:47' },
      { name: 'Passing',   type: 'nonclass', start: '07:47', end: '07:50' },

      { name: 'Period 1',  type: 'class',    start: '07:50', end: '08:34' },
      { name: 'Passing',   type: 'nonclass', start: '08:34', end: '08:37' },

      { name: 'Period 2',  type: 'class',    start: '08:37', end: '09:21' },
      { name: 'Passing',   type: 'nonclass', start: '09:21', end: '09:24' },

      { name: 'Period 3',  type: 'class',    start: '09:24', end: '10:08' },
      { name: 'Passing',   type: 'nonclass', start: '10:08', end: '10:11' },

      { name: 'Period 4',  type: 'class',    start: '10:11', end: '10:54' },
      { name: 'Passing',   type: 'nonclass', start: '10:54', end: '10:57' },

      { name: 'Period 5',  type: 'class',    start: '10:57', end: '11:41' },
      { name: 'Passing',   type: 'nonclass', start: '11:41', end: '11:44' },

      { name: 'Period 6',  type: 'class',    start: '11:44', end: '12:28' },
      { name: 'Passing',   type: 'nonclass', start: '12:28', end: '12:31' },

      { name: 'Period 7',  type: 'class',    start: '12:31', end: '13:15' }
    ];

    function getDaySchedule(dateObj) {
      const day = dateObj.getDay(); // 0 Sun ... 5 Fri ... 6 Sat
      if (day === 5) return { type: 'Friday', items: scheduleFriday };
      if (day >= 1 && day <= 4) return { type: 'Mon-Thu', items: scheduleMonThu };
      return { type: 'Weekend', items: [] };
    }

    function getSegmentForNow(scheduleItems, nowMin) {
      for (let i = 0; i < scheduleItems.length; i++) {
        const it = scheduleItems[i];
        const s = hmToMin(it.start);
        const e = hmToMin(it.end);
        if (nowMin >= s && nowMin < e) {
          const next = scheduleItems[i+1] || null;
          return { current: it, startMin: s, endMin: e, next };
        }
      }
      const upcoming = scheduleItems.find(it => nowMin < hmToMin(it.start)) || null;
      return { current: null, startMin: null, endMin: null, next: upcoming };
    }

    // =========================
    // 2) IN-PERIOD ROUTINE
    // =========================
    const routineUnits = [5, 30, 5, 5];
    const TOTAL_UNITS = routineUnits.reduce((a,b)=>a+b,0); // 45
    const SCALE_TO_PERIOD = true;

    function routineStageAt(progressSec, periodLenSec) {
      const total = periodLenSec;
      const unitSec = SCALE_TO_PERIOD ? (total / TOTAL_UNITS) : 60;
      const scaled = routineUnits.map(u => u * unitSec);

      let acc = 0;
      for (let i = 0; i < scaled.length; i++) {
        const start = acc;
        const end = acc + scaled[i];
        if (progressSec >= start && progressSec < end) {
          return { stage: i, stageStart: start, stageEnd: end, unitSec };
        }
        acc = end;
      }
      return { stage: 3, stageStart: total - scaled[3], stageEnd: total, unitSec };
    }

    // =========================
    // 3) SIMULATION MODE
    // =========================
    let simulationOn = false;
    const SIM_SPEED = 60; // 60x => 1s = 1 min

    let simAnchorRealMs = null;
    let simAnchorScheduleMin = null;

    function getNowForEngine() {
      const realNow = new Date();
      if (!simulationOn) return realNow;

      if (simAnchorRealMs === null) {
        simAnchorRealMs = Date.now();
        simAnchorScheduleMin = toMinSinceMidnight(realNow);
      }

      const elapsedRealSec = (Date.now() - simAnchorRealMs) / 1000;
      const elapsedScheduleSec = elapsedRealSec * SIM_SPEED;

      const totalMin = simAnchorScheduleMin + (elapsedScheduleSec / 60);

      const baseMidnight = new Date(realNow);
      baseMidnight.setHours(0,0,0,0);

      const fake = new Date(realNow);
      fake.setTime(baseMidnight.getTime() + totalMin * 60 * 1000);
      return fake;
    }

    // =========================
    // 4) UI HOOKS
    // =========================
    const stageCards  = document.querySelectorAll('.stage-card');
    const stageSound  = document.getElementById('stageSound');

    const modeLabel = document.getElementById('modeLabel');
    const timeLeftLabel = document.getElementById('timeLeftLabel');
    const segmentLabel = document.getElementById('segmentLabel');
    const statusText = document.getElementById('statusText');

    const todayTypePill = document.getElementById('todayTypePill');
    const nowPill = document.getElementById('nowPill');
    const nextPill = document.getElementById('nextPill');

    const timerBar = document.getElementById('timerBar');

    const tLogin = document.getElementById('tLogin');
    const tLearn = document.getElementById('tLearn');
    const tTyping = document.getElementById('tTyping');
    const tLogout = document.getElementById('tLogout');

    const toggleSimBtn = document.getElementById('toggleSimBtn');
    const resetSimBtn = document.getElementById('resetSimBtn');

    // MINI weekly hooks
    const mwGrid = document.getElementById('mwGrid');
    const mwNowLine = document.getElementById('mwNowLine');
    const mwNowLabel = document.getElementById('mwNowLabel');

    // =========================
    // TIMER BAR (45 UNITS)
    // =========================
    let smoothFillEl = null;

    function buildGradient() {
      const colors = ['#0071e3', '#34c759', '#ff9f0a', '#ff2d55'];
      let acc = 0;
      const stops = [];
      for (let i = 0; i < routineUnits.length; i++) {
        const startPct = (acc / TOTAL_UNITS) * 100;
        acc += routineUnits[i];
        const endPct = (acc / TOTAL_UNITS) * 100;
        stops.push(`${colors[i]} ${startPct.toFixed(3)}%`);
        stops.push(`${colors[i]} ${endPct.toFixed(3)}%`);
      }
      return `linear-gradient(90deg, ${stops.join(', ')})`;
    }

    function createUnits() {
      timerBar.innerHTML = '';

      smoothFillEl = document.createElement('div');
      smoothFillEl.className = 'smooth-fill';
      smoothFillEl.style.background = buildGradient();
      smoothFillEl.style.width = '0%';
      timerBar.appendChild(smoothFillEl);

      for (let i = 0; i < TOTAL_UNITS; i++) {
        const unit = document.createElement('div');
        unit.className = 'progress-unit';

        let cumulative = 0;
        for (let stage = 0; stage < routineUnits.length; stage++) {
          cumulative += routineUnits[stage];
          if (i < cumulative) {
            unit.classList.add(`stage-${stage}`);
            break;
          }
        }
        unit.style.left = `${i * (100 / TOTAL_UNITS)}%`;
        timerBar.appendChild(unit);
      }
    }

    function playStageSound() {
      stageSound.currentTime = 0;
      stageSound.play().catch(() => {});
    }

    // =========================
    // MINI WEEKLY GRID BUILD
    // =========================
    const days = ['M','T','W','R','F'];
    const periods = [1,2,3,4,5,6,7,8,9];

    // Simple mapping now (edit later as you want)
    const weeklyMap = {
      M: { 1:'Tech',2:'Tech',3:'Tech',4:'Open',5:'Tech',6:'Tech',7:'Tech',8:'Open',9:'Duty' },
      T: { 1:'Open',2:'Tech',3:'Tech',4:'Open',5:'Tech',6:'Tech',7:'Tech',8:'Tech',9:'Tech' },
      W: { 1:'Tech',2:'Open',3:'Tech',4:'Open',5:'Tech',6:'Tech',7:'Open',8:'Tech',9:'Tech' },
      R: { 1:'Tech',2:'Tech',3:'Tech',4:'Open',5:'Open',6:'Tech',7:'Tech',8:'Open',9:'Duty' },
      F: { 1:'Open',2:'Open',3:'GT',4:'Open',5:'Open',6:'Open',7:'Tech',8:'No',9:'No' }
    };

    function buildMiniWeekly(){
      const keep = 6; // corner + 5 day headers already in HTML
      while (mwGrid.children.length > keep) mwGrid.removeChild(mwGrid.lastChild);

      for (const p of periods){
        const rl = document.createElement('div');
        rl.className = 'mw-rowlabel';
        rl.textContent = String(p).padStart(2,'0');
        mwGrid.appendChild(rl);

        for (const d of days){
          const cell = document.createElement('div');
          cell.className = 'mw-cell';
          const text = (weeklyMap[d] && weeklyMap[d][p]) ? weeklyMap[d][p] : '';
          cell.textContent = text || '';
          if (text && text !== 'Open' && text !== 'No') cell.classList.add('hasclass');
          cell.dataset.day = d;
          cell.dataset.period = String(p);
          mwGrid.appendChild(cell);
        }
      }
    }

    function dowToLetter(dateObj){
      const dow = dateObj.getDay(); // 0 Sun, 1 Mon..5 Fri
      if (dow === 1) return 'M';
      if (dow === 2) return 'T';
      if (dow === 3) return 'W';
      if (dow === 4) return 'R';
      if (dow === 5) return 'F';
      return null;
    }

    function updateMiniWeekly(now){
      const dayLetter = dowToLetter(now);

      const allCells = mwGrid.querySelectorAll('.mw-cell');
      allCells.forEach(c => c.classList.remove('active'));

      if (!dayLetter){
        mwNowLine.style.display = 'none';
        return;
      }
      mwNowLine.style.display = 'block';

      const dayInfo = getDaySchedule(now);
      const items = dayInfo.items;
      const nowMin = toMinSinceMidnight(now);

      const seg = getSegmentForNow(items, nowMin);

      if (!items.length){
        mwNowLine.style.display = 'none';
        return;
      }

      const startMin = hmToMin(items[0].start);
      const endMin = hmToMin(items[items.length - 1].end);
      const totalSpanMin = Math.max(1, endMin - startMin);

      const posMin = Math.max(0, Math.min(totalSpanMin, nowMin - startMin));
      const pct = posMin / totalSpanMin;

      const gridRect = mwGrid.getBoundingClientRect();
      const headerRowHeight = 28;
      const usableTop = headerRowHeight + 6;
      const usableHeight = gridRect.height - usableTop - 6;

      const y = usableTop + usableHeight * pct;
      mwNowLine.style.transform = `translateY(${y}px)`;

      if (seg.current && seg.current.type === 'class') {
        const match = seg.current.name.match(/Period\s+(\d+)/i);
        if (match){
          const p = match[1];
          const cell = mwGrid.querySelector(`.mw-cell[data-day="${dayLetter}"][data-period="${p}"]`);
          if (cell) cell.classList.add('active');
        }
        mwNowLabel.textContent = 'Now';
      } else if (seg.current) {
        mwNowLabel.textContent = seg.current.name;
      } else {
        mwNowLabel.textContent = 'Now';
      }
    }

    // =========================
    // MAIN ENGINE TICK
    // =========================
    let lastStage = -1;

    function setPill(el, text) { el.textContent = text; }

    function tick() {
      const now = getNowForEngine();
      const dayInfo = getDaySchedule(now);
      const items = dayInfo.items;

      setPill(todayTypePill, 'Today: ' + dayInfo.type);

      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const ss = String(now.getSeconds()).padStart(2,'0');
      setPill(nowPill, 'Time: ' + hh + ':' + mm + ':' + ss);

      // update mini weekly widget
      updateMiniWeekly(now);

      if (dayInfo.type === 'Weekend' || items.length === 0) {
        setPill(nextPill, 'Next: —');
        modeLabel.textContent = simulationOn ? 'Sim' : 'Auto';
        segmentLabel.textContent = 'Weekend';
        timeLeftLabel.textContent = '--:--';
        statusText.textContent = 'Weekend mode. (No bell schedule configured.)';
        stageCards.forEach(c => { c.classList.remove('active'); c.classList.add('dimmed'); });
        if (smoothFillEl) smoothFillEl.style.width = '0%';
        lastStage = -1;
        return;
      }

      const nowMin = toMinSinceMidnight(now);
      const seg = getSegmentForNow(items, nowMin);

      const nextText = seg.next ? (seg.next.name + ' @ ' + seg.next.start) : '—';
      setPill(nextPill, 'Next: ' + nextText);

      modeLabel.textContent = simulationOn ? 'Sim' : 'Auto';

      // before/after schedule
      if (!seg.current) {
        stageCards.forEach(c => { c.classList.remove('active'); c.classList.add('dimmed'); });
        segmentLabel.textContent = seg.next ? ('Waiting for ' + seg.next.name) : 'After school';
        timeLeftLabel.textContent = '--:--';
        statusText.textContent = seg.next ? ('Not in schedule yet. Next: ' + seg.next.name) : 'Schedule complete.';
        if (smoothFillEl) smoothFillEl.style.width = '0%';
        lastStage = -1;

        tLogin.textContent  = '—';
        tLearn.textContent  = '—';
        tTyping.textContent = '—';
        tLogout.textContent = '—';
        return;
      }

      const segStart = seg.startMin;
      const segEnd = seg.endMin;
      const segLenSec = (segEnd - segStart) * 60;
      const segElapsedSec = clamp((nowMin - segStart) * 60, 0, segLenSec);
      const segRemainingSec = Math.max(0, segLenSec - segElapsedSec);

      segmentLabel.textContent = seg.current.name + ' (' + seg.current.start + '–' + seg.current.end + ')';
      timeLeftLabel.textContent = formatHMS(segRemainingSec);

      // Non-class segments
      if (seg.current.type !== 'class') {
        stageCards.forEach(c => { c.classList.remove('active'); c.classList.add('dimmed'); });

        const pct = (segElapsedSec / segLenSec) * 100;
        if (smoothFillEl) smoothFillEl.style.width = clamp(pct, 0, 100) + '%';

        const unitNow = Math.floor((segElapsedSec / segLenSec) * TOTAL_UNITS);
        const allUnits = timerBar.querySelectorAll('.progress-unit');
        allUnits.forEach((u, idx) => u.classList.toggle('active', idx < unitNow));

        statusText.textContent = 'Non-class segment: ' + seg.current.name;
        lastStage = -1;

        tLogin.textContent  = '—';
        tLearn.textContent  = '—';
        tTyping.textContent = '—';
        tLogout.textContent = '—';
        return;
      }

      // Class segment -> 4-stage routine scaled to this period
      stageCards.forEach(c => c.classList.remove('dimmed'));

      const info = routineStageAt(segElapsedSec, segLenSec);
      const stage = info.stage;

      stageCards.forEach((card, idx) => card.classList.toggle('active', idx === stage));

      if (lastStage !== -1 && stage !== lastStage) playStageSound();
      lastStage = stage;

      const pct = (segElapsedSec / segLenSec) * 100;
      if (smoothFillEl) smoothFillEl.style.width = clamp(pct, 0, 100) + '%';

      const unitNow = Math.floor((segElapsedSec / segLenSec) * TOTAL_UNITS);
      const allUnits = timerBar.querySelectorAll('.progress-unit');
      allUnits.forEach((u, idx) => u.classList.toggle('active', idx < unitNow));

      const unitSec = SCALE_TO_PERIOD ? (segLenSec / TOTAL_UNITS) : 60;
      const d0 = routineUnits[0] * unitSec;
      const d1 = routineUnits[1] * unitSec;
      const d2 = routineUnits[2] * unitSec;
      const d3 = routineUnits[3] * unitSec;

      tLogin.textContent  = 'Duration: ' + formatHMS(d0);
      tLearn.textContent  = 'Duration: ' + formatHMS(d1);
      tTyping.textContent = 'Duration: ' + formatHMS(d2);
      tLogout.textContent = 'Duration: ' + formatHMS(d3);

      const stageRemaining = Math.max(0, info.stageEnd - segElapsedSec);
      statusText.textContent =
        seg.current.name + ' | Stage ' + (stage+1) + '/4 | Stage left: ' + formatHMS(stageRemaining);
    }

    // Buttons
    toggleSimBtn.addEventListener('click', () => {
      simulationOn = !simulationOn;
      toggleSimBtn.textContent = 'Simulation: ' + (simulationOn ? 'ON' : 'OFF');

      simAnchorRealMs = null;
      simAnchorScheduleMin = null;
      lastStage = -1;
      tick();
    });

    resetSimBtn.addEventListener('click', () => {
      simAnchorRealMs = null;
      simAnchorScheduleMin = null;
      lastStage = -1;
      tick();
    });

    // Init
    buildMiniWeekly();
    createUnits();
    toggleSimBtn.textContent = 'Simulation: OFF';
    setInterval(tick, 250);
    tick();
  </script>
</body>
</html>
