<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech App with Mr. Oz - Real Bell Schedule</title>

  <style>
    :root{
      --bg: #f5f5f7;
      --card: rgba(255,255,255,0.78);
      --text: #1d1d1f;
      --muted: rgba(29,29,31,0.68);
      --line: rgba(0,0,0,0.10);
      --shadow: 0 18px 45px rgba(0,0,0,0.10);
      --shadow2: 0 8px 20px rgba(0,0,0,0.08);

      --blue:  #0071e3;
      --green: #34c759;
      --amber: #ff9f0a;
      --pink:  #ff2d55;

      --gray: rgba(29,29,31,0.25);
    }

    html, body { height: 100%; }

    body {
      margin: 0;
      font-family:
        -apple-system, BlinkMacSystemFont,
        "SF Pro Display", "SF Pro Text",
        "Helvetica Neue", Helvetica, Arial,
        "Segoe UI", Roboto, "Noto Sans",
        "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 700px at 50% 0%, #ffffff 0%, var(--bg) 55%, #efeff2 100%);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      letter-spacing: -0.01em;
    }

    header {
      text-align: center;
      padding: 22px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(245,245,247,0.70));
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    header h1 {
      margin: 0;
      font-size: clamp(32px, 3.3vw, 44px);
      line-height: 1.06;
      letter-spacing: -0.02em;
      font-weight: 700;
      color: var(--text);
    }

    header .subtitle {
      display: block;
      margin-top: 10px;
      font-size: 17px;
      line-height: 1.35;
      color: rgba(29,29,31,0.75);
      letter-spacing: -0.005em;
      font-weight: 500;
    }

    header .subrow {
      margin-top: 8px;
      font-size: 14px;
      color: rgba(29,29,31,0.68);
      font-weight: 600;
      letter-spacing: -0.005em;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    header .pill {
      background: rgba(255,255,255,0.75);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 34px 20px;
    }

    .card-row {
      display: flex;
      gap: 18px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .stage-card {
      background: var(--card);
      border-radius: 22px;
      padding: 22px;
      position: relative;
      box-shadow: var(--shadow2);
      border: 1px solid var(--line);
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, opacity 0.2s ease;
      min-width: 210px;
      flex: 1;
      max-width: 250px;
      overflow: hidden;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .stage-card.dimmed {
      opacity: 0.45;
      transform: none !important;
      box-shadow: 0 10px 18px rgba(0,0,0,0.06);
    }

    /* rainbow-ish rotating ring */
    .stage-card::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: conic-gradient(
        rgba(0,0,0,0) 0deg,
        rgba(0,0,0,0) 14deg,
        #ff2d55 70deg,
        #ff9f0a 110deg,
        #34c759 150deg,
        #0071e3 200deg,
        rgba(0,0,0,0) 260deg,
        rgba(0,0,0,0) 360deg
      );
      border-radius: 26px;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s ease;
      animation: none;
      filter: blur(10px);
      pointer-events: none;
    }

    .stage-card.active {
      transform: translateY(-10px) scale(1.03);
      border-color: transparent;
      box-shadow: var(--shadow);
    }

    .stage-card.active::before {
      opacity: 1;
      animation: neonRotate 3s linear infinite;
    }

    @keyframes neonRotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stage-title {
      font-size: 20px;
      line-height: 1.2;
      font-weight: 700;
      text-align: center;
      position: relative;
      z-index: 10;
      letter-spacing: -0.015em;
    }

    .stage-time {
      font-size: 14px;
      line-height: 1.25;
      text-align: center;
      position: relative;
      z-index: 10;
      color: rgba(29,29,31,0.62);
      font-weight: 600;
      letter-spacing: -0.005em;
    }

    .stage-image {
      flex: 1;
      border-radius: 14px;
      background-size: cover;
      background-position: center;
      min-height: 120px;
      position: relative;
      z-index: 10;
      border: 1px solid var(--line);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
    }

    .img-login   { background: linear-gradient(135deg, rgba(0,113,227,0.22) 0%, rgba(0,113,227,0.06) 100%); }
    .img-learn   { background: linear-gradient(135deg, rgba(52,199,89,0.22) 0%, rgba(52,199,89,0.06) 100%); }
    .img-typing  { background: linear-gradient(135deg, rgba(255,159,10,0.22) 0%, rgba(255,159,10,0.06) 100%); }
    .img-logout  { background: linear-gradient(135deg, rgba(255,45,85,0.22) 0%, rgba(255,45,85,0.06) 100%); }

    footer {
      padding: 18px 20px 24px;
      background: linear-gradient(180deg, rgba(245,245,247,0.78), rgba(255,255,255,0.78));
      border-top: 1px solid var(--line);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .timer-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .time-label {
      font-size: 15px;
      line-height: 1.2;
      color: rgba(29,29,31,0.72);
      min-width: 260px;
      font-weight: 600;
      letter-spacing: -0.005em;
    }

    .time-label span {
      font-weight: 700;
      color: var(--blue);
    }

    .timer-bar {
      flex: 1;
      height: 24px;
      background: rgba(255,255,255,0.85);
      border-radius: 999px;
      border: 1px solid var(--line);
      overflow: hidden;
      position: relative;
      min-width: 350px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.9);
    }

    .smooth-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      border-radius: 999px;
      transition: width 0.12s linear;
      opacity: 0.95;
      pointer-events: none;
    }

    .progress-unit {
      position: absolute;
      top: 0;
      height: 100%;
      width: calc(100% / 45);
      opacity: 0.10;
      transition: opacity 0.2s ease;
      border-radius: 999px;
      pointer-events: none;
    }

    .progress-unit.stage-0 { background: linear-gradient(90deg, rgba(0,113,227,0.9), rgba(0,113,227,0.55)); }
    .progress-unit.stage-1 { background: linear-gradient(90deg, rgba(52,199,89,0.9), rgba(52,199,89,0.55)); }
    .progress-unit.stage-2 { background: linear-gradient(90deg, rgba(255,159,10,0.9), rgba(255,159,10,0.55)); }
    .progress-unit.stage-3 { background: linear-gradient(90deg, rgba(255,45,85,0.9), rgba(255,45,85,0.55)); }

    .progress-unit.active { opacity: 0.26; }

    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }

    .btn {
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      background: linear-gradient(180deg, rgba(0,113,227,0.95), rgba(0,113,227,0.80));
      color: #fff;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      box-shadow: 0 8px 18px rgba(0,113,227,0.18);
      letter-spacing: -0.01em;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 22px rgba(0,113,227,0.22);
    }

    .btn.secondary {
      background: linear-gradient(180deg, rgba(255,255,255,0.90), rgba(245,245,247,0.90));
      color: var(--text);
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }

    .btn.secondary:hover { box-shadow: 0 12px 22px rgba(0,0,0,0.10); }

    .status-text {
      text-align: center;
      font-size: 14px;
      color: rgba(29,29,31,0.68);
      margin-top: 8px;
      font-weight: 600;
      letter-spacing: -0.005em;
    }

    @media (prefers-reduced-motion: reduce) {
      .stage-card, .stage-card::before { transition: none; animation: none; }
      .smooth-fill { transition: none; }
    }

    @media (max-width: 768px) {
      .card-row { flex-direction: column; gap: 15px; }
      .stage-card { max-width: none; flex: 1; min-width: 250px; }
      .timer-bar { min-width: 300px; }
      .time-label { min-width: 220px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Tech App with Mr. Oz</h1>
    <span class="subtitle">Real-time bell schedule + in-period routine</span>
    <div class="subrow">
      <div class="pill" id="todayTypePill">Today: ...</div>
      <div class="pill" id="nowPill">Now: ...</div>
      <div class="pill" id="nextPill">Next: ...</div>
    </div>
  </header>

  <main>
    <div class="card-row">
      <div class="stage-card" data-stage="0">
        <div class="stage-title">Login</div>
        <div class="stage-time" id="tLogin">...</div>
        <div class="stage-image img-login"></div>
      </div>
      <div class="stage-card" data-stage="1">
        <div class="stage-title">Learning.com</div>
        <div class="stage-time" id="tLearn">...</div>
        <div class="stage-image img-learn"></div>
      </div>
      <div class="stage-card" data-stage="2">
        <div class="stage-title">Typing.com</div>
        <div class="stage-time" id="tTyping">...</div>
        <div class="stage-image img-typing"></div>
      </div>
      <div class="stage-card" data-stage="3">
        <div class="stage-title">Logout</div>
        <div class="stage-time" id="tLogout">...</div>
        <div class="stage-image img-logout"></div>
      </div>
    </div>
  </main>

  <footer>
    <div class="timer-row">
      <div class="time-label">
        <span id="modeLabel">Auto</span> · <span id="timeLeftLabel">--:--</span> · <span id="segmentLabel">...</span>
      </div>
      <div class="timer-bar" id="timerBar"></div>
    </div>

    <div class="controls">
      <button class="btn secondary" id="toggleSimBtn">Simulation: OFF</button>
      <button class="btn" id="resetSimBtn">Reset Sim</button>
      <div class="status-text" id="statusText">Uses local computer time. Simulation lets you test fast.</div>
    </div>

    <audio id="stageSound" src="beep.mp3" preload="auto"></audio>
  </footer>

  <script>
    /*
      Goal:
      - Use REAL bell schedule: Mon-Thu vs Friday.
      - When we are inside a Period segment, run your 4-step routine (Login/Learning/Typing/Logout)
        scaled to that period length (so it always fits no matter 48 min or 44 min).
      - When we are in Passing/Breakfast/etc, dim cards and show segment info.

      You can later replace the "Period label" with your exact class name from your own schedule,
      but for now it behaves like you have class every period.
    */

    // =========================
    // 1) BELL SCHEDULE CONFIG
    // =========================

    // Helper: HH:MM -> minutes since midnight
    function hmToMin(hm) {
      const [h, m] = hm.split(':').map(Number);
      return h * 60 + m;
    }

    // Convert "7:50" or "1:46" etc in 12-hour context:
    // We'll provide 24-hour manually below to avoid ambiguity.
    // (If you want, we can add a smarter parser later.)

    const scheduleMonThu = [
      { name: 'Breakfast', type: 'nonclass', start: '07:20', end: '07:47' },
      { name: 'Passing',   type: 'nonclass', start: '07:47', end: '07:50' },

      { name: 'Period 1',  type: 'class',    start: '07:50', end: '08:38' },
      { name: 'Passing',   type: 'nonclass', start: '08:38', end: '08:41' },

      { name: 'Period 2',  type: 'class',    start: '08:41', end: '09:29' },
      { name: 'Passing',   type: 'nonclass', start: '09:29', end: '09:32' },

      { name: 'Period 3',  type: 'class',    start: '09:32', end: '10:20' },
      { name: 'Passing',   type: 'nonclass', start: '10:20', end: '10:23' },

      { name: 'Period 4',  type: 'class',    start: '10:23', end: '11:10' },
      { name: 'Passing',   type: 'nonclass', start: '11:10', end: '11:13' },

      { name: 'Period 5',  type: 'class',    start: '11:13', end: '12:01' },
      { name: 'Passing',   type: 'nonclass', start: '12:01', end: '12:04' },

      { name: 'Period 6',  type: 'class',    start: '12:04', end: '12:52' },
      { name: 'Passing',   type: 'nonclass', start: '12:52', end: '12:55' },

      { name: 'Period 7',  type: 'class',    start: '12:55', end: '13:43' },
      { name: 'Passing',   type: 'nonclass', start: '13:43', end: '13:46' },

      { name: 'Period 8',  type: 'class',    start: '13:46', end: '14:34' },
      { name: 'Passing',   type: 'nonclass', start: '14:34', end: '14:37' },

      { name: 'Period 9',  type: 'class',    start: '14:37', end: '15:25' }
    ];

    const scheduleFriday = [
      { name: 'Breakfast', type: 'nonclass', start: '07:20', end: '07:47' },
      { name: 'Passing',   type: 'nonclass', start: '07:47', end: '07:50' },

      { name: 'Period 1',  type: 'class',    start: '07:50', end: '08:34' },
      { name: 'Passing',   type: 'nonclass', start: '08:34', end: '08:37' },

      { name: 'Period 2',  type: 'class',    start: '08:37', end: '09:21' },
      { name: 'Passing',   type: 'nonclass', start: '09:21', end: '09:24' },

      { name: 'Period 3',  type: 'class',    start: '09:24', end: '10:08' },
      { name: 'Passing',   type: 'nonclass', start: '10:08', end: '10:11' },

      { name: 'Period 4',  type: 'class',    start: '10:11', end: '10:54' },
      { name: 'Passing',   type: 'nonclass', start: '10:54', end: '10:57' },

      { name: 'Period 5',  type: 'class',    start: '10:57', end: '11:41' },
      { name: 'Passing',   type: 'nonclass', start: '11:41', end: '11:44' },

      { name: 'Period 6',  type: 'class',    start: '11:44', end: '12:28' },
      { name: 'Passing',   type: 'nonclass', start: '12:28', end: '12:31' },

      { name: 'Period 7',  type: 'class',    start: '12:31', end: '13:15' }
      // You wrote no Period 8/9 for Friday (makes sense). If you want, we can add them.
    ];

    function getDaySchedule(dateObj) {
      const day = dateObj.getDay(); // 0 Sun ... 5 Fri ... 6 Sat
      if (day === 5) return { type: 'Friday', items: scheduleFriday };
      if (day >= 1 && day <= 4) return { type: 'Mon-Thu', items: scheduleMonThu };
      return { type: 'Weekend', items: [] };
    }

    // =========================
    // 2) IN-PERIOD ROUTINE
    // =========================
    // Your routine parts. We will scale these proportions to the actual period length.
    // If you want fixed minutes regardless of period length, set SCALE_TO_PERIOD = false.
    const routineUnits = [5, 30, 5, 5]; // login, learning, typing, logout
    const TOTAL_UNITS = routineUnits.reduce((a,b)=>a+b,0); // 45
    const SCALE_TO_PERIOD = true;

    // =========================
    // 3) SIMULATION MODE (for testing)
    // =========================
    // If simulation is ON: we compress time so you can watch it.
    // Example: 1 real second = 1 bell-minute. Change SIM_SPEED if you want faster.
    let simulationOn = false;
    const SIM_SPEED = 60; // 60x faster => 1 sec equals 60 sec (1 minute)

    // =========================
    // 4) UI HOOKS
    // =========================
    const stageCards  = document.querySelectorAll('.stage-card');
    const stageSound  = document.getElementById('stageSound');

    const modeLabel = document.getElementById('modeLabel');
    const timeLeftLabel = document.getElementById('timeLeftLabel');
    const segmentLabel = document.getElementById('segmentLabel');
    const statusText = document.getElementById('statusText');

    const todayTypePill = document.getElementById('todayTypePill');
    const nowPill = document.getElementById('nowPill');
    const nextPill = document.getElementById('nextPill');

    const timerBar = document.getElementById('timerBar');

    const tLogin = document.getElementById('tLogin');
    const tLearn = document.getElementById('tLearn');
    const tTyping = document.getElementById('tTyping');
    const tLogout = document.getElementById('tLogout');

    const toggleSimBtn = document.getElementById('toggleSimBtn');
    const resetSimBtn = document.getElementById('resetSimBtn');

    // smooth fill + 45 units
    let smoothFillEl = null;

    function buildGradient() {
      const colors = ['#0071e3', '#34c759', '#ff9f0a', '#ff2d55'];
      let acc = 0;
      const stops = [];
      for (let i = 0; i < routineUnits.length; i++) {
        const startPct = (acc / TOTAL_UNITS) * 100;
        acc += routineUnits[i];
        const endPct = (acc / TOTAL_UNITS) * 100;
        stops.push(`${colors[i]} ${startPct.toFixed(3)}%`);
        stops.push(`${colors[i]} ${endPct.toFixed(3)}%`);
      }
      return `linear-gradient(90deg, ${stops.join(', ')})`;
    }

    function createUnits() {
      timerBar.innerHTML = '';

      smoothFillEl = document.createElement('div');
      smoothFillEl.className = 'smooth-fill';
      smoothFillEl.style.background = buildGradient();
      smoothFillEl.style.width = '0%';
      timerBar.appendChild(smoothFillEl);

      for (let i = 0; i < TOTAL_UNITS; i++) {
        const unit = document.createElement('div');
        unit.className = 'progress-unit';

        let cumulative = 0;
        for (let stage = 0; stage < routineUnits.length; stage++) {
          cumulative += routineUnits[stage];
          if (i < cumulative) {
            unit.classList.add(`stage-${stage}`);
            break;
          }
        }
        unit.style.left = `${i * (100 / TOTAL_UNITS)}%`;
        timerBar.appendChild(unit);
      }
    }

    function playStageSound() {
      stageSound.currentTime = 0;
      stageSound.play().catch(() => {});
    }

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function formatHMS(totalSeconds) {
      totalSeconds = Math.max(0, Math.floor(totalSeconds));
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      if (h > 0) return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
      return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    }

    function toMinSinceMidnight(dateObj) {
      return dateObj.getHours() * 60 + dateObj.getMinutes() + dateObj.getSeconds()/60;
    }

    function getSegmentForNow(scheduleItems, nowMin) {
      for (let i = 0; i < scheduleItems.length; i++) {
        const it = scheduleItems[i];
        const s = hmToMin(it.start);
        const e = hmToMin(it.end);
        if (nowMin >= s && nowMin < e) {
          const next = scheduleItems[i+1] || null;
          return { current: it, startMin: s, endMin: e, next };
        }
      }
      // Not in any segment
      // Find next upcoming
      const upcoming = scheduleItems.find(it => nowMin < hmToMin(it.start)) || null;
      return { current: null, startMin: null, endMin: null, next: upcoming };
    }

    function routineStageAt(progressSec, periodLenSec) {
      // Returns stage index 0..3 and stage boundaries based on scaling
      const total = periodLenSec;

      const sumUnits = TOTAL_UNITS;
      const unitSec = SCALE_TO_PERIOD ? (total / sumUnits) : 60; // if fixed: 1 unit = 60 sec (45 min routine)
      const scaled = routineUnits.map(u => u * unitSec);

      let acc = 0;
      for (let i = 0; i < scaled.length; i++) {
        const start = acc;
        const end = acc + scaled[i];
        if (progressSec >= start && progressSec < end) {
          return { stage: i, stageStart: start, stageEnd: end, unitSec };
        }
        acc = end;
      }
      return { stage: 3, stageStart: total - scaled[3], stageEnd: total, unitSec };
    }

    let lastStage = -1;
    let simAnchorRealMs = null;
    let simAnchorScheduleMin = null;

    function getNowForEngine() {
      const realNow = new Date();

      if (!simulationOn) return realNow;

      // Simulation: we freeze "schedule clock" start at the moment you enabled sim,
      // then run it faster using SIM_SPEED.
      if (simAnchorRealMs === null) {
        simAnchorRealMs = Date.now();
        simAnchorScheduleMin = toMinSinceMidnight(realNow);
      }
      const elapsedRealSec = (Date.now() - simAnchorRealMs) / 1000;
      const elapsedScheduleSec = elapsedRealSec * SIM_SPEED;

      const totalMin = simAnchorScheduleMin + (elapsedScheduleSec / 60);
      const fake = new Date(realNow);
      const baseMidnight = new Date(realNow);
      baseMidnight.setHours(0,0,0,0);

      const fakeMs = baseMidnight.getTime() + totalMin * 60 * 1000;
      fake.setTime(fakeMs);
      return fake;
    }

    function setPill(el, text) { el.textContent = text; }

    function tick() {
      const now = getNowForEngine();
      const dayInfo = getDaySchedule(now);
      const items = dayInfo.items;

      setPill(todayTypePill, 'Today: ' + dayInfo.type);

      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const ss = String(now.getSeconds()).padStart(2,'0');
      setPill(nowPill, 'Time: ' + hh + ':' + mm + ':' + ss);

      if (dayInfo.type === 'Weekend' || items.length === 0) {
        setPill(nextPill, 'Next: —');
        modeLabel.textContent = simulationOn ? 'Sim' : 'Auto';
        segmentLabel.textContent = 'Weekend';
        timeLeftLabel.textContent = '--:--';
        statusText.textContent = 'Weekend mode. (No bell schedule configured.)';
        stageCards.forEach(c => { c.classList.remove('active'); c.classList.add('dimmed'); });
        if (smoothFillEl) smoothFillEl.style.width = '0%';
        return;
      }

      const nowMin = toMinSinceMidnight(now);
      const seg = getSegmentForNow(items, nowMin);

      const nextText = seg.next ? (seg.next.name + ' @ ' + seg.next.start) : '—';
      setPill(nextPill, 'Next: ' + nextText);

      modeLabel.textContent = simulationOn ? 'Sim' : 'Auto';

      // Before school / after school
      if (!seg.current) {
        stageCards.forEach(c => { c.classList.remove('active'); c.classList.add('dimmed'); });
        segmentLabel.textContent = seg.next ? ('Waiting for ' + seg.next.name) : 'After school';
        timeLeftLabel.textContent = '--:--';
        statusText.textContent = seg.next ? ('Not in schedule yet. Next: ' + seg.next.name) : 'Schedule complete.';
        if (smoothFillEl) smoothFillEl.style.width = '0%';
        lastStage = -1;
        return;
      }

      const segStart = seg.startMin;
      const segEnd = seg.endMin;
      const segLenSec = (segEnd - segStart) * 60;
      const segElapsedSec = clamp((nowMin - segStart) * 60, 0, segLenSec);
      const segRemainingSec = Math.max(0, segLenSec - segElapsedSec);

      segmentLabel.textContent = seg.current.name + ' (' + seg.current.start + '–' + seg.current.end + ')';
      timeLeftLabel.textContent = formatHMS(segRemainingSec);

      // If not a class segment: dim cards and show segment progress as bar
      if (seg.current.type !== 'class') {
        stageCards.forEach(c => { c.classList.remove('active'); c.classList.add('dimmed'); });

        // bar shows segment progress using same gradient (nice look)
        const pct = (segElapsedSec / segLenSec) * 100;
        if (smoothFillEl) smoothFillEl.style.width = clamp(pct, 0, 100) + '%';

        // units shading: just mark by pct mapped to units
        const unitNow = Math.floor((segElapsedSec / segLenSec) * TOTAL_UNITS);
        const allUnits = timerBar.querySelectorAll('.progress-unit');
        allUnits.forEach((u, idx) => u.classList.toggle('active', idx < unitNow));

        statusText.textContent = 'Non-class segment: ' + seg.current.name;
        lastStage = -1;

        // Show routine times scaled to a "typical" class just as reference
        tLogin.textContent  = '—';
        tLearn.textContent  = '—';
        tTyping.textContent = '—';
        tLogout.textContent = '—';
        return;
      }

      // Class segment: run routine inside this period
      stageCards.forEach(c => c.classList.remove('dimmed'));

      const info = routineStageAt(segElapsedSec, segLenSec);
      const stage = info.stage;

      stageCards.forEach((card, idx) => card.classList.toggle('active', idx === stage));

      // Beep when stage changes
      if (lastStage !== -1 && stage !== lastStage) playStageSound();
      lastStage = stage;

      // Update bar progress (period progress)
      const pct = (segElapsedSec / segLenSec) * 100;
      if (smoothFillEl) smoothFillEl.style.width = clamp(pct, 0, 100) + '%';

      // 45-unit shading based on progress (regardless of how long the period is)
      const unitNow = Math.floor((segElapsedSec / segLenSec) * TOTAL_UNITS);
      const allUnits = timerBar.querySelectorAll('.progress-unit');
      allUnits.forEach((u, idx) => u.classList.toggle('active', idx < unitNow));

      // Show each stage duration (scaled) as text
      const unitSec = SCALE_TO_PERIOD ? (segLenSec / TOTAL_UNITS) : 60;
      const d0 = routineUnits[0] * unitSec;
      const d1 = routineUnits[1] * unitSec;
      const d2 = routineUnits[2] * unitSec;
      const d3 = routineUnits[3] * unitSec;

      tLogin.textContent  = 'Duration: ' + formatHMS(d0);
      tLearn.textContent  = 'Duration: ' + formatHMS(d1);
      tTyping.textContent = 'Duration: ' + formatHMS(d2);
      tLogout.textContent = 'Duration: ' + formatHMS(d3);

      // Status: stage time remaining inside period
      const stageRemaining = Math.max(0, info.stageEnd - segElapsedSec);
      statusText.textContent =
        seg.current.name + ' | Stage ' + (stage+1) + '/4 | Stage left: ' + formatHMS(stageRemaining);
    }

    // Buttons
    toggleSimBtn.addEventListener('click', () => {
      simulationOn = !simulationOn;
      toggleSimBtn.textContent = 'Simulation: ' + (simulationOn ? 'ON' : 'OFF');

      // reset sim anchors so it starts clean when enabled
      simAnchorRealMs = null;
      simAnchorScheduleMin = null;
      lastStage = -1;
      tick();
    });

    resetSimBtn.addEventListener('click', () => {
      simAnchorRealMs = null;
      simAnchorScheduleMin = null;
      lastStage = -1;
      tick();
    });

    // Init
    createUnits();
    toggleSimBtn.textContent = 'Simulation: OFF';
    setInterval(tick, 250);
    tick();
  </script>
</body>
</html>
