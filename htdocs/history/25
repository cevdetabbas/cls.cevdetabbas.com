<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tech App with Mr. Oz - Classroom Timer</title>

  <style>
    :root{
      --bg: #f5f5f7;
      --card: rgba(255,255,255,0.86);
      --text: #1d1d1f;
      --line: rgba(0,0,0,0.10);
      --shadow: 0 18px 45px rgba(0,0,0,0.10);
      --shadow2: 0 10px 24px rgba(0,0,0,0.10);

      --blue:  #0071e3;
      --green: #34c759;
      --amber: #ff9f0a;
      --pink:  #ff2d55;
    }

    html, body { height: 100%; }

    body {
      margin: 0;
      font-family:
        -apple-system, BlinkMacSystemFont,
        "SF Pro Display", "SF Pro Text",
        "Helvetica Neue", Helvetica, Arial,
        "Segoe UI", Roboto, "Noto Sans",
        "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 700px at 50% 0%, #ffffff 0%, var(--bg) 55%, #efeff2 100%);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      letter-spacing: -0.01em;
    }

    header {
      padding: 18px 16px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.90), rgba(245,245,247,0.74));
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      position: relative;
      overflow: hidden;
    }

    header::after{
      content:"";
      position:absolute;
      inset:-60px -80px -80px -80px;
      background:
        radial-gradient(520px 190px at 15% 40%, rgba(0,113,227,0.18), transparent 60%),
        radial-gradient(520px 190px at 85% 40%, rgba(255,45,85,0.14), transparent 60%),
        radial-gradient(520px 210px at 50% 120%, rgba(52,199,89,0.12), transparent 60%);
      filter: blur(10px);
      pointer-events:none;
      z-index:0;
    }

    .header-grid{
      position: relative;
      z-index: 2;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
      max-width: 1400px;
      margin: 0 auto;
    }

    header h1 {
      margin: 0;
      text-align: center;
      font-size: clamp(36px, 3.6vw, 56px);
      line-height: 1.05;
      letter-spacing: -0.02em;
      font-weight: 900;
      color: var(--text);
      white-space: nowrap;
    }

    .hdr-left, .hdr-right{
      display: flex;
      align-items: center;
      min-width: 0;
    }
    .hdr-left{ justify-content: flex-start; }
    .hdr-right{ justify-content: flex-end; }

    .hdr-chip{
      border-radius: 16px;
      padding: 10px 14px;
      background: rgba(255,255,255,0.80);
      border: 1px solid rgba(0,0,0,0.12);
      box-shadow: 0 14px 34px rgba(0,0,0,0.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow: hidden;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.03em;
      font-weight: 950;
      line-height: 1;
      font-size: clamp(26px, 2.2vw, 44px);
      white-space: nowrap;
      color: rgba(29,29,31,0.92);
    }

    .hdr-chip.time{
      color: #fff;
      background: rgba(0,0,0,0.78);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow:
        0 16px 46px rgba(0,0,0,0.18),
        0 0 22px rgba(0,113,227,0.14),
        0 0 18px rgba(52,199,89,0.10),
        0 0 18px rgba(255,45,85,0.08);
    }

    .blink-colon{
      animation: blink 1s steps(2, end) infinite;
      display: inline-block;
      width: 0.35em;
      text-align: center;
      opacity: 0.9;
    }
    @keyframes blink { 50% { opacity: 0.15; } }

    @media (max-width: 980px){
      .header-grid{
        grid-template-columns: 1fr;
        justify-items: center;
        gap: 10px;
      }
      .hdr-left, .hdr-right{ justify-content: center; }
      header h1{ white-space: normal; }
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 22px 20px 16px;
    }

    .card-row {
      width: min(1320px, 100%);
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 18px;
      align-items: stretch;
    }

    .stage-card {
      background: var(--card);
      border-radius: 24px;
      padding: 18px;
      position: relative;
      box-shadow: var(--shadow2);
      border: 1px solid var(--line);
      display: flex;
      flex-direction: column;
      gap: 14px;
      overflow: hidden;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      transform: translateY(0);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
    }

    .stage-card.dimmed {
      opacity: 0.40;
      transform: none !important;
    }

    .stage-card.active {
      transform: translateY(-8px);
      box-shadow: var(--shadow);
      border-color: rgba(0,0,0,0.16);
    }

    .stage-title {
      font-size: clamp(22px, 2.0vw, 32px);
      line-height: 1.15;
      font-weight: 900;
      text-align: center;
      letter-spacing: -0.02em;
    }

    .stage-title .mins{
      display:block;
      margin-top: 6px;
      font-size: 0.72em;
      font-weight: 900;
      letter-spacing: -0.01em;
      color: rgba(29,29,31,0.70);
    }

    .stage-circle{
      position: relative;
      flex: 1;
      min-height: 250px;
      display: grid;
      place-items: center;
    }

    .ring{
      width: min(270px, 92%);
      aspect-ratio: 1 / 1;
      position: relative;
      display:grid;
      place-items:center;
    }

    .ring svg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      transform: rotate(-90deg);
      filter: drop-shadow(0 14px 24px rgba(0,0,0,0.12));
      pointer-events:none;
    }

    .ring .bg{
      stroke: rgba(0,0,0,0.12);
      stroke-width: 16;
      fill: rgba(255,255,255,0.55);
    }

    .ring .fg{
      stroke-width: 16;
      fill: none;
      stroke-linecap: round;
      stroke-dasharray: 999;
      stroke-dashoffset: 999;
      transition: stroke-dashoffset 0.12s linear;
      opacity: 0.96;
    }

    .fg.stage-0{ stroke: var(--blue); }
    .fg.stage-1{ stroke: var(--green); }
    .fg.stage-2{ stroke: var(--amber); }
    .fg.stage-3{ stroke: var(--pink); }

    .inner-circle{
      width: 74%;
      height: 74%;
      border-radius: 50%;
      overflow: hidden;
      background: rgba(255,255,255,0.82);
      border: 1px solid rgba(0,0,0,0.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.85);
      display: grid;
      place-items: center;
    }

    .inner-circle img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      user-select:none;
      -webkit-user-drag:none;
      filter: saturate(1.02);
    }

    .stage-countdown{
      text-align:center;
      font-variant-numeric: tabular-nums;
      font-size: clamp(36px, 3.2vw, 62px);
      font-weight: 950;
      letter-spacing: -0.03em;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.18s ease, transform 0.18s ease;
      color: rgba(29,29,31,0.82);
    }

    .stage-card.active .stage-countdown{
      opacity: 1;
      transform: translateY(0);
    }

    .stage-card.active .stage-countdown.neonish{
      color: #ffffff;
      background: rgba(0,0,0,0.78);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow:
        0 16px 46px rgba(0,0,0,0.22),
        0 0 22px rgba(0,113,227,0.12),
        0 0 22px rgba(255,45,85,0.08);
    }

    footer {
      padding: 16px 20px 22px;
      background: linear-gradient(180deg, rgba(245,245,247,0.80), rgba(255,255,255,0.82));
      border-top: 1px solid var(--line);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .big-timer-wrap{
      width: min(1320px, 100%);
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .big-countdown{
      position: relative;
      border-radius: 24px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow:
        0 18px 52px rgba(0,0,0,0.20),
        0 0 26px rgba(0,113,227,0.14),
        0 0 22px rgba(255,45,85,0.10);
      background: rgba(0,0,0,0.78);
      display: grid;
      grid-template-columns: 1fr;
      padding: 16px 18px;
    }

    .big-fill{
      position: absolute;
      inset: 0;
      width: 0%;
      height: 100%;
      opacity: 0.26;
      pointer-events: none;
      transition: width 0.12s linear;
    }

    .big-fill.stage-0{ background: linear-gradient(90deg, rgba(0,113,227,0.95), rgba(0,113,227,0.10)); }
    .big-fill.stage-1{ background: linear-gradient(90deg, rgba(52,199,89,0.95), rgba(52,199,89,0.10)); }
    .big-fill.stage-2{ background: linear-gradient(90deg, rgba(255,159,10,0.95), rgba(255,159,10,0.10)); }
    .big-fill.stage-3{ background: linear-gradient(90deg, rgba(255,45,85,0.95), rgba(255,45,85,0.10)); }

    .big-inner{
      position: relative;
      z-index: 2;
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 14px;
      align-items: center;
      width: 100%;
    }

    .big-left{
      display: grid;
      gap: 8px;
      align-content: center;
      color: #fff;
    }

    .big-segment{
      font-size: clamp(22px, 2.2vw, 34px);
      font-weight: 900;
      letter-spacing: -0.02em;
      opacity: 0.95;
    }

    .big-stage{
      font-size: clamp(18px, 1.8vw, 28px);
      font-weight: 800;
      opacity: 0.88;
    }

    .big-time{
      text-align: right;
      color: #fff;
      font-variant-numeric: tabular-nums;
      font-size: clamp(60px, 7.4vw, 120px);
      line-height: 1;
      font-weight: 950;
      letter-spacing: -0.03em;
      text-shadow:
        0 0 10px rgba(0,113,227,0.22),
        0 0 18px rgba(52,199,89,0.14),
        0 10px 40px rgba(0,0,0,0.28);
    }

    .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 4px;
    }

    .btn {
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 999px;
      padding: 14px 22px;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
      background: linear-gradient(180deg, rgba(0,113,227,0.95), rgba(0,113,227,0.80));
      color: #fff;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 22px rgba(0,113,227,0.18);
      letter-spacing: -0.01em;
    }

    .btn:hover { transform: translateY(-2px); }

    .btn.secondary {
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(245,245,247,0.92));
      color: var(--text);
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }

    .status-text {
      text-align: center;
      font-size: 16px;
      color: rgba(29,29,31,0.70);
      margin-top: 6px;
      font-weight: 700;
      letter-spacing: -0.005em;
    }

    @media (max-width: 1100px) {
      .card-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 700px) {
      .card-row { grid-template-columns: 1fr; }
      .big-inner{ grid-template-columns: 1fr; }
      .big-time{ text-align: left; }
    }

    @media (prefers-reduced-motion: reduce) {
      .fg, .big-fill { transition: none; }
      .stage-card { transition: none; }
      .blink-colon{ animation: none; }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-grid">
      <div class="hdr-left">
        <div class="hdr-chip" id="dateChip">01/08/2026</div>
      </div>

      <h1>Tech App with Mr. Oz</h1>

      <div class="hdr-right">
        <div class="hdr-chip time" id="timeChip">11:12:22 AM</div>
      </div>
    </div>
  </header>

  <main>
    <div class="card-row">
      <div class="stage-card" data-stage="0">
        <div class="stage-title">
          Login
          <span class="mins" id="label0">...</span>
        </div>

        <div class="stage-circle">
          <div class="ring">
            <svg viewBox="0 0 120 120" aria-hidden="true">
              <circle class="bg" cx="60" cy="60" r="48"></circle>
              <circle class="fg stage-0" id="ring0" cx="60" cy="60" r="48"></circle>
            </svg>

            <div class="inner-circle">
              <img src="./images/login.png" alt="Login" />
            </div>
          </div>
        </div>

        <div class="stage-countdown neonish" id="cd0">--:--</div>
      </div>

      <div class="stage-card" data-stage="1">
        <div class="stage-title">
          Learning.com
          <span class="mins" id="label1">...</span>
        </div>

        <div class="stage-circle">
          <div class="ring">
            <svg viewBox="0 0 120 120" aria-hidden="true">
              <circle class="bg" cx="60" cy="60" r="48"></circle>
              <circle class="fg stage-1" id="ring1" cx="60" cy="60" r="48"></circle>
            </svg>

            <div class="inner-circle">
              <img src="./images/learning.png" alt="Learning.com" />
            </div>
          </div>
        </div>

        <div class="stage-countdown neonish" id="cd1">--:--</div>
      </div>

      <div class="stage-card" data-stage="2">
        <div class="stage-title">
          Typing.com
          <span class="mins" id="label2">...</span>
        </div>

        <div class="stage-circle">
          <div class="ring">
            <svg viewBox="0 0 120 120" aria-hidden="true">
              <circle class="bg" cx="60" cy="60" r="48"></circle>
              <circle class="fg stage-2" id="ring2" cx="60" cy="60" r="48"></circle>
            </svg>

            <div class="inner-circle">
              <img src="./images/typing.png" alt="Typing.com" />
            </div>
          </div>
        </div>

        <div class="stage-countdown neonish" id="cd2">--:--</div>
      </div>

      <div class="stage-card" data-stage="3">
        <div class="stage-title">
          Logout
          <span class="mins" id="label3">...</span>
        </div>

        <div class="stage-circle">
          <div class="ring">
            <svg viewBox="0 0 120 120" aria-hidden="true">
              <circle class="bg" cx="60" cy="60" r="48"></circle>
              <circle class="fg stage-3" id="ring3" cx="60" cy="60" r="48"></circle>
            </svg>

            <div class="inner-circle">
              <img src="./images/logout.png" alt="Logout" />
            </div>
          </div>
        </div>

        <div class="stage-countdown neonish" id="cd3">--:--</div>
      </div>
    </div>
  </main>

  <footer>
    <div class="big-timer-wrap">
      <div class="big-countdown">
        <div class="big-fill stage-0" id="bigFill"></div>

        <div class="big-inner">
          <div class="big-left">
            <div class="big-segment" id="bigSegment">...</div>
            <div class="big-stage" id="bigStage">...</div>
          </div>
          <div class="big-time" id="bigTime">--:--</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn secondary" id="toggleSimBtn">Simulation: OFF</button>
        <button class="btn" id="resetSimBtn">Reset Sim</button>
      </div>

      <div class="status-text" id="statusText">Uses local computer time. Simulation lets you test fast.</div>

      <audio id="stageSound" src="beep.mp3" preload="auto"></audio>
    </div>
  </footer>

  <script>
    // login = 3 min (keep in mind)
    const assignedMinutes = [3, 30, 10, 2];
    const SCALE_TO_PERIOD = true;

    // San Antonio timezone
    const TZ = 'America/Chicago';

    // Elementary School (PreK-5) schedule from your table:
    // Mon-Thu: Breakfast 7:20-7:47, Passing 3 min, P1 7:50-8:38, Passing 3, P2 8:41-9:29, Passing 3, P3 9:32-10:20, Passing 3, P4 10:23-11:10, Passing 3, P5 11:13-12:01, Passing 3, P6 12:04-12:52, Passing 3, P7 12:55-1:43, Passing 3, P8 1:46-2:34, Passing 3, P9 2:37-3:25
    // Friday: P1 7:50-8:34, Passing 3, P2 8:37-9:21, Passing 3, P3 9:24-10:08, Passing 3, P4 10:11-10:54, Passing 3, P5 10:57-11:41, Passing 3, P6 11:44-12:28, Passing 3, P7 12:31-1:15

    function hmToMin(hm) {
      const [h, m] = hm.split(':').map(Number);
      return h * 60 + m;
    }

    const scheduleMonThu = [
      { name: 'Breakfast', type: 'nonclass', start: '07:20', end: '07:47' },
      { name: 'Passing',   type: 'nonclass', start: '07:47', end: '07:50' },

      { name: 'Period 1',  type: 'class',    start: '07:50', end: '08:38' },
      { name: 'Passing',   type: 'nonclass', start: '08:38', end: '08:41' },

      { name: 'Period 2',  type: 'class',    start: '08:41', end: '09:29' },
      { name: 'Passing',   type: 'nonclass', start: '09:29', end: '09:32' },

      { name: 'Period 3',  type: 'class',    start: '09:32', end: '10:20' },
      { name: 'Passing',   type: 'nonclass', start: '10:20', end: '10:23' },

      { name: 'Period 4',  type: 'class',    start: '10:23', end: '11:10' },
      { name: 'Passing',   type: 'nonclass', start: '11:10', end: '11:13' },

      { name: 'Period 5',  type: 'class',    start: '11:13', end: '12:01' },
      { name: 'Passing',   type: 'nonclass', start: '12:01', end: '12:04' },

      { name: 'Period 6',  type: 'class',    start: '12:04', end: '12:52' },
      { name: 'Passing',   type: 'nonclass', start: '12:52', end: '12:55' },

      { name: 'Period 7',  type: 'class',    start: '12:55', end: '13:43' },
      { name: 'Passing',   type: 'nonclass', start: '13:43', end: '13:46' },

      { name: 'Period 8',  type: 'class',    start: '13:46', end: '14:34' },
      { name: 'Passing',   type: 'nonclass', start: '14:34', end: '14:37' },

      { name: 'Period 9',  type: 'class',    start: '14:37', end: '15:25' }
    ];

    const scheduleFriday = [
      { name: 'Breakfast', type: 'nonclass', start: '07:20', end: '07:47' },
      { name: 'Passing',   type: 'nonclass', start: '07:47', end: '07:50' },

      { name: 'Period 1',  type: 'class',    start: '07:50', end: '08:34' },
      { name: 'Passing',   type: 'nonclass', start: '08:34', end: '08:37' },

      { name: 'Period 2',  type: 'class',    start: '08:37', end: '09:21' },
      { name: 'Passing',   type: 'nonclass', start: '09:21', end: '09:24' },

      { name: 'Period 3',  type: 'class',    start: '09:24', end: '10:08' },
      { name: 'Passing',   type: 'nonclass', start: '10:08', end: '10:11' },

      { name: 'Period 4',  type: 'class',    start: '10:11', end: '10:54' },
      { name: 'Passing',   type: 'nonclass', start: '10:54', end: '10:57' },

      { name: 'Period 5',  type: 'class',    start: '10:57', end: '11:41' },
      { name: 'Passing',   type: 'nonclass', start: '11:41', end: '11:44' },

      { name: 'Period 6',  type: 'class',    start: '11:44', end: '12:28' },
      { name: 'Passing',   type: 'nonclass', start: '12:28', end: '12:31' },

      { name: 'Period 7',  type: 'class',    start: '12:31', end: '13:15' }
    ];

    function getDaySchedule(dateObj) {
      const day = dateObj.getDay(); // 0 Sun ... 5 Fri
      if (day === 5) return { type: 'Friday', items: scheduleFriday };
      if (day >= 1 && day <= 4) return { type: 'Mon-Thu', items: scheduleMonThu };
      return { type: 'Weekend', items: [] };
    }

    // Simulation
    let simulationOn = false;
    const SIM_SPEED = 60;

    // UI hooks
    const stageCards = document.querySelectorAll('.stage-card');
    const stageSound = document.getElementById('stageSound');

    const bigSegment = document.getElementById('bigSegment');
    const bigStage = document.getElementById('bigStage');
    const bigTime = document.getElementById('bigTime');
    const bigFill = document.getElementById('bigFill');

    const statusText = document.getElementById('statusText');
    const toggleSimBtn = document.getElementById('toggleSimBtn');
    const resetSimBtn = document.getElementById('resetSimBtn');

    const ringEls = [
      document.getElementById('ring0'),
      document.getElementById('ring1'),
      document.getElementById('ring2'),
      document.getElementById('ring3'),
    ];

    const cdEls = [
      document.getElementById('cd0'),
      document.getElementById('cd1'),
      document.getElementById('cd2'),
      document.getElementById('cd3'),
    ];

    const labelEls = [
      document.getElementById('label0'),
      document.getElementById('label1'),
      document.getElementById('label2'),
      document.getElementById('label3'),
    ];

    const dateChip = document.getElementById('dateChip');
    const timeChip = document.getElementById('timeChip');

    function playStageSound() {
      stageSound.currentTime = 0;
      stageSound.play().catch(() => {});
    }

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function formatHMS(totalSeconds) {
      totalSeconds = Math.max(0, Math.floor(totalSeconds));
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      if (h > 0) return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
      return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    }

    function nowInTZParts(tz) {
      const parts = new Intl.DateTimeFormat('en-US', {
        timeZone: tz,
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      }).formatToParts(new Date());

      const get = (type) => parts.find(p => p.type === type)?.value;
      return {
        year: Number(get('year')),
        month: Number(get('month')),
        day: Number(get('day')),
        hour: Number(get('hour')),
        minute: Number(get('minute')),
        second: Number(get('second')),
      };
    }

    function nowInTZDate(tz) {
      const p = nowInTZParts(tz);
      return new Date(p.year, p.month - 1, p.day, p.hour, p.minute, p.second);
    }

    function updateHeaderClock() {
      const now = getNowForEngine();

      const MM = String(now.getMonth() + 1).padStart(2,'0');
      const DD = String(now.getDate()).padStart(2,'0');
      const YYYY = now.getFullYear();
      dateChip.textContent = `${MM}/${DD}/${YYYY}`;

      let h = now.getHours();
      const ampm = h >= 12 ? 'AM' : 'AM'; // placeholder (fixed below)

      const AMPM = (now.getHours() >= 12) ? 'PM' : 'AM';
      h = h % 12; if (h === 0) h = 12;

      const HH = String(h).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const ss = String(now.getSeconds()).padStart(2,'0');

      timeChip.innerHTML = `${HH}<span class="blink-colon">:</span>${mm}<span class="blink-colon">:</span>${ss} ${AMPM}`;
    }

    function toMinSinceMidnight(dateObj) {
      return dateObj.getHours() * 60 + dateObj.getMinutes() + dateObj.getSeconds()/60;
    }

    function getSegmentForNow(scheduleItems, nowMin) {
      for (let i = 0; i < scheduleItems.length; i++) {
        const it = scheduleItems[i];
        const s = hmToMin(it.start);
        const e = hmToMin(it.end);
        if (nowMin >= s && nowMin < e) {
          const next = scheduleItems[i+1] || null;
          return { current: it, startMin: s, endMin: e, next };
        }
      }
      const upcoming = scheduleItems.find(it => nowMin < hmToMin(it.start)) || null;
      return { current: null, startMin: null, endMin: null, next: upcoming };
    }

    function setRingProgress(ringEl, pct) {
      const r = 48;
      const C = 2 * Math.PI * r;
      ringEl.style.strokeDasharray = C.toFixed(3);
      ringEl.style.strokeDashoffset = (C * (1 - clamp(pct, 0, 100)/100)).toFixed(3);
    }

    function setAllRings(stageIdx, stagePct){
      for (let i = 0; i < ringEls.length; i++) {
        setRingProgress(ringEls[i], (i === stageIdx) ? stagePct : 0);
      }
    }

    function setBigFill(stageIdx, pct){
      bigFill.className = 'big-fill stage-' + stageIdx;
      bigFill.style.width = clamp(pct, 0, 100) + '%';
    }

    function stageName(i){
      return ['Login', 'Learning.com', 'Typing.com', 'Logout'][i] || '';
    }

    function computeStageDurationsSec(periodLenSec){
      const baseTotalMin = assignedMinutes.reduce((a,b)=>a+b,0);
      if (!SCALE_TO_PERIOD) return assignedMinutes.map(m => m * 60);
      return assignedMinutes.map(m => (m / baseTotalMin) * periodLenSec);
    }

    function stageAt(segElapsedSec, durationsSec){
      let acc = 0;
      for (let i = 0; i < durationsSec.length; i++) {
        const start = acc;
        const end = acc + durationsSec[i];
        if (segElapsedSec >= start && segElapsedSec < end) {
          return { stage: i, stageStart: start, stageEnd: end };
        }
        acc = end;
      }
      const total = durationsSec.reduce((a,b)=>a+b,0);
      return { stage: 3, stageStart: total - durationsSec[3], stageEnd: total };
    }

    // Simulation engine
    let lastStage = -1;
    let simAnchorRealMs = null;
    let simAnchorScheduleMin = null;

    function getNowForEngine() {
      const realNow = nowInTZDate(TZ);
      if (!simulationOn) return realNow;

      if (simAnchorRealMs === null) {
        simAnchorRealMs = Date.now();
        simAnchorScheduleMin = toMinSinceMidnight(realNow);
      }
      const elapsedRealSec = (Date.now() - simAnchorRealMs) / 1000;
      const elapsedScheduleSec = elapsedRealSec * SIM_SPEED;

      const totalMin = simAnchorScheduleMin + (elapsedScheduleSec / 60);
      const baseMidnight = new Date(realNow);
      baseMidnight.setHours(0,0,0,0);

      const fake = new Date(realNow);
      fake.setTime(baseMidnight.getTime() + totalMin * 60 * 1000);
      return fake;
    }

    function initTitleLabels(){
      for (let i = 0; i < assignedMinutes.length; i++) {
        labelEls[i].textContent = assignedMinutes[i] + ' min';
      }
    }

    function tick() {
      updateHeaderClock();

      const now = getNowForEngine();
      const dayInfo = getDaySchedule(now);
      const items = dayInfo.items;

      if (dayInfo.type === 'Weekend' || items.length === 0) {
        bigSegment.textContent = 'Weekend';
        bigStage.textContent = 'No schedule';
        bigTime.textContent = '--:--';
        statusText.textContent = 'Weekend mode.';

        stageCards.forEach(c => { c.classList.remove('active'); c.classList.add('dimmed'); });
        setAllRings(-1, 0);
        setBigFill(0, 0);
        cdEls.forEach(el => el.textContent = '--:--');
        lastStage = -1;
        return;
      }

      const nowMin = toMinSinceMidnight(now);
      const seg = getSegmentForNow(items, nowMin);

      if (!seg.current) {
        const label = seg.next ? ('Waiting for ' + seg.next.name + ' @ ' + seg.next.start) : 'After school';
        bigSegment.textContent = label;
        bigStage.textContent = '';
        bigTime.textContent = '--:--';
        statusText.textContent = seg.next ? ('Next: ' + seg.next.name) : 'Schedule complete.';

        stageCards.forEach(c => { c.classList.remove('active'); c.classList.add('dimmed'); });
        setAllRings(-1, 0);
        setBigFill(0, 0);
        cdEls.forEach(el => el.textContent = '--:--');
        lastStage = -1;
        return;
      }

      const segStart = seg.startMin;
      const segEnd = seg.endMin;

      const segLenSec = (segEnd - segStart) * 60;
      const segElapsedSec = clamp((nowMin - segStart) * 60, 0, segLenSec);
      const segRemainingSec = Math.max(0, segLenSec - segElapsedSec);

      const overallPct = (segElapsedSec / segLenSec) * 100;

      if (seg.current.type !== 'class') {
        bigSegment.textContent = seg.current.name + ' (' + seg.current.start + '–' + seg.current.end + ')';
        bigStage.textContent = 'Non-class segment';
        bigTime.textContent = formatHMS(segRemainingSec);

        statusText.textContent = seg.current.name;

        stageCards.forEach(c => { c.classList.remove('active'); c.classList.add('dimmed'); });
        setAllRings(-1, 0);
        setBigFill(0, overallPct);
        cdEls.forEach(el => el.textContent = '--:--');

        lastStage = -1;
        return;
      }

      const durationsSec = computeStageDurationsSec(segLenSec);
      const info = stageAt(segElapsedSec, durationsSec);
      const stage = info.stage;

      stageCards.forEach(c => c.classList.remove('dimmed'));
      stageCards.forEach((card, idx) => card.classList.toggle('active', idx === stage));

      const stagePct = ((segElapsedSec - info.stageStart) / Math.max(0.001, (info.stageEnd - info.stageStart))) * 100;
      setAllRings(stage, clamp(stagePct, 0, 100));
      setBigFill(stage, overallPct);

      for (let i = 0; i < cdEls.length; i++) {
        if (i === stage) {
          const stageRemaining = Math.max(0, info.stageEnd - segElapsedSec);
          cdEls[i].textContent = formatHMS(stageRemaining);
        } else {
          cdEls[i].textContent = '--:--';
        }
      }

      if (lastStage !== -1 && stage !== lastStage) playStageSound();
      lastStage = stage;

      const stageRemaining = Math.max(0, info.stageEnd - segElapsedSec);

      bigSegment.textContent = seg.current.name + ' (' + seg.current.start + '–' + seg.current.end + ')';
      bigStage.textContent = 'Now: ' + stageName(stage) + ' | Stage left: ' + formatHMS(stageRemaining);
      bigTime.textContent = formatHMS(segRemainingSec);

      statusText.textContent = (simulationOn ? 'Simulation ON' : 'Auto') + ' | ' + dayInfo.type;
    }

    toggleSimBtn.addEventListener('click', () => {
      simulationOn = !simulationOn;
      toggleSimBtn.textContent = 'Simulation: ' + (simulationOn ? 'ON' : 'OFF');

      simAnchorRealMs = null;
      simAnchorScheduleMin = null;
      lastStage = -1;
      tick();
    });

    resetSimBtn.addEventListener('click', () => {
      simAnchorRealMs = null;
      simAnchorScheduleMin = null;
      lastStage = -1;
      tick();
    });

    initTitleLabels();
    toggleSimBtn.textContent = 'Simulation: OFF';
    setInterval(tick, 250);
    tick();
  </script>
</body>
</html>

